(function(k){"object"==typeof exports&&"object"==typeof module?k(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror"],k):k(CodeMirror)})(function(k){function C(a,d,b){var c=a.docs[d];c?b(y(a,c)):a.options.getFile?a.options.getFile(d,b):b(null)}function v(a,d,b){for(var c in a.docs){var e=a.docs[c];if(e.doc==d)return e}if(!b)for(b=0;;++b)if(c="[doc"+(b||"")+"]",!a.docs[c]){b=c;break}return a.addDoc(b,d)}function D(a,d){if("string"==typeof d)return a.docs[d];
d instanceof k&&(d=d.getDoc());if(d instanceof k.Doc)return v(a,d)}function M(a,d,b){var c=v(a,d),e=a.cachedArgHints;e&&e.doc==d&&0>=z(e.start,b.to)&&(a.cachedArgHints=null);e=c.changed;null==e&&(c.changed=e={from:b.from.line,to:b.from.line});var f=b.from.line+(b.text.length-1);b.from.line<e.to&&(e.to-=b.to.line-f);f>=e.to&&(e.to=f+1);e.from>b.from.line&&(e.from=b.from.line);d.lineCount()>E&&100<b.to-e.from&&setTimeout(function(){c.changed&&100<c.changed.to-c.changed.from&&F(a,c)},200)}function F(a,
d){a.server.request({files:[{type:"full",name:d.name,text:y(a,d)}]},function(a){a?window.console.error(a):d.changed=null})}function N(a,d,b){a.request(d,{type:"completions",types:!0,docs:!0,urls:!0},function(c,e){if(c)return u(a,d,c);var f=[],h="",l=e.start,g=e.end;'["'==d.getRange(t(l.line,l.ch-2),l)&&'"]'!=d.getRange(g,t(g.line,g.ch+2))&&(h='"]');for(var w=0;w<e.completions.length;++w){var m=e.completions[w],q=O(m.type);e.guess&&(q+=" "+n+"guess");f.push({text:m.name+h,displayText:m.name,className:q,
data:m})}var f={from:l,to:g,list:f},p=null;k.on(f,"close",function(){x(p)});k.on(f,"update",function(){x(p)});k.on(f,"select",function(d,b){x(p);var c=a.options.completionTip?a.options.completionTip(d.data):d.data.doc;c&&(p=B(b.parentNode.getBoundingClientRect().right+window.pageXOffset,b.getBoundingClientRect().top+window.pageYOffset,c),p.className+=" "+n+"hint-doc")});b(f)})}function O(a){a="?"==a?"unknown":"number"==a||"string"==a||"bool"==a?a:/^fn\(/.test(a)?"fn":/^\[/.test(a)?"array":"object";
return n+"completion "+n+"completion-"+a}function G(a,d,b,c,e){a.request(d,c,function(b,c){if(b)return u(a,d,b);if(a.options.typeTip)var l=a.options.typeTip(c);else if(l=r("span",null,r("strong",null,c.type||"not found")),c.doc&&l.appendChild(document.createTextNode(" \u2014 "+c.doc)),c.url){l.appendChild(document.createTextNode(" "));var g=l.appendChild(r("a",null,"[docs]"));g.href=c.url;g.target="_blank"}H(d,l);e&&e()},b)}function P(a,d){A(a);if(!d.somethingSelected()){var b=d.getTokenAt(d.getCursor()).state,
b=k.innerMode(d.getMode(),b);if("javascript"==b.mode.name&&(b=b.state.lexical,"call"==b.info)){for(var c,e=b.pos||0,f=d.getOption("tabSize"),h=d.getCursor().line,l=Math.max(0,h-9),g=!1;h>=l;--h){for(var w=d.getLine(h),m=c=0;;){var q=w.indexOf("\t",m);if(-1==q)break;c+=f-(q+c)%f-1;m=q+1}c=b.column-c;if("("==w.charAt(c)){g=!0;break}}if(g){b=t(h,c);if((c=a.cachedArgHints)&&c.doc==d.getDoc()&&0==z(b,c.start))return I(a,d,e);a.request(d,{type:"type",preferFunction:!0,end:b},function(b,c){!b&&c.type&&/^fn\(/.test(c.type)&&
(a.cachedArgHints={start:m,type:Q(c.type),name:c.exprName||c.name||"fn",guess:c.guess,doc:d.getDoc()},I(a,d,e))})}}}}function I(a,d,b){A(a);for(var c=a.cachedArgHints,e=c.type,c=r("span",c.guess?n+"fhint-guess":null,r("span",n+"fname",c.name),"("),f=0;f<e.args.length;++f){f&&c.appendChild(document.createTextNode(", "));var h=e.args[f];c.appendChild(r("span",n+"farg"+(f==b?" "+n+"farg-current":""),h.name||"?"));"?"!=h.type&&(c.appendChild(document.createTextNode(":\u00a0")),c.appendChild(r("span",
n+"type",h.type)))}c.appendChild(document.createTextNode(e.rettype?") ->\u00a0":")"));e.rettype&&c.appendChild(r("span",n+"type",e.rettype));d=d.cursorCoords(null,"page");a.activeArgHints=B(d.right+1,d.bottom,c)}function Q(a){function d(d){for(var b=0,e=c;;){var g=a.charAt(c);if(d.test(g)&&!b)return a.slice(e,c);/[{\[\(]/.test(g)?++b:/[}\]\)]/.test(g)&&--b;++c}}var b=[],c=3;if(")"!=a.charAt(c))for(;;){var e=a.slice(c).match(/^([^, \(\[\{]+): /);e&&(c+=e[0].length,e=e[1]);b.push({name:e,type:d(/[\),]/)});
if(")"==a.charAt(c))break;c+=2}e=a.slice(c).match(/^\) -> (.*)$/);return{args:b,rettype:e&&e[1]}}function R(a,d){function b(b){b={type:"definition",variable:b||null};var e=v(a,d.getDoc());a.server.request(J(a,e,b),function(b,c){if(b)return u(a,d,b);if(!c.file&&c.url)window.open(c.url);else{if(c.file){var l=a.docs[c.file],g,k;if(k=l){var m;var q=l.doc;g=c.context.slice(0,c.contextOffset).split("\n");var p=c.start.line-(g.length-1);k=t(p,(1==g.length?c.start.ch:q.getLine(p).length)-g[0].length);for(var n=
q.getLine(p).slice(k.ch),p=p+1;p<q.lineCount()&&n.length<c.context.length;++p)n+="\n"+q.getLine(p);if(n.slice(0,c.context.length)==c.context)m=c;else{q=q.getSearchCursor(c.context,0,!1);for(n=Infinity;q.findNext();){var p=q.from(),r=1E4*Math.abs(p.line-k.line);r||(r=Math.abs(p.ch-k.ch));r<n&&(m=p,n=r)}m?(1==g.length?m.ch+=g[0].length:m=t(m.line+(g.length-1),g[g.length-1].length),g=c.start.line==c.end.line?t(m.line,m.ch+(c.end.ch-c.start.ch)):t(m.line+(c.end.line-c.start.line),c.end.ch),m={start:m,
end:g}):m=null}k=g=m}if(k){a.jumpStack.push({file:e.name,start:d.getCursor("from"),end:d.getCursor("to")});K(a,e,l,g.start,g.end);return}}u(a,d,"Could not find a definition.")}})}S(d)?b():L(d,"Jump to variable",function(a){a&&b(a)})}function K(a,d,b,c,e){b.doc.setSelection(c,e);d!=b&&a.options.switchToDoc&&(A(a),a.options.switchToDoc(b.name,b.doc))}function S(a){var d=a.getCursor("end"),b=a.getTokenAt(d);return b.start<d.ch&&("comment"==b.type||"string"==b.type)?!1:/\w/.test(a.getLine(d.line).slice(Math.max(d.ch-
1,0),d.ch+1))}function T(a,d){var b=d.getTokenAt(d.getCursor());if(!/\w/.test(b.string))return u(a,d,"Not at a variable");L(d,"New name for "+b.string,function(b){a.request(d,{type:"rename",newName:b,fullDocs:!0},function(b,c){if(b)return u(a,d,b);U(a,c.changes)})})}function V(a,d){var b=v(a,d.doc).name;a.request(d,{type:"refs"},function(c,e){if(c)return u(a,d,c);for(var f=[],h=0,l=0;l<e.refs.length;l++){var g=e.refs[l];g.file==b&&(f.push({anchor:g.start,head:g.end}),0<=z(h,g.start)&&0>=z(h,g.end)&&
(h=f.length-1))}d.setSelections(f,h)})}function U(a,d){for(var b=Object.create(null),c=0;c<d.length;++c){var e=d[c];(b[e.file]||(b[e.file]=[])).push(e)}for(var f in b){var h=a.docs[f],l=b[f];if(h){l.sort(function(a,b){return z(b.start,a.start)});for(var g="*rename"+ ++W,c=0;c<l.length;++c)e=l[c],h.doc.replaceRange(e.text,e.start,e.end,g)}}}function J(a,d,b,c){var e=[],f=0;(f=!b.fullDocs)||delete b.fullDocs;"string"==typeof b&&(b={type:b});b.lineCharPositions=!0;null==b.end&&(b.end=c||d.doc.getCursor("end"),
d.doc.somethingSelected()&&(b.start=d.doc.getCursor("start")));c=b.start||b.end;d.changed?d.doc.lineCount()>E&&!1!==f&&100>d.changed.to-d.changed.from&&d.changed.from<=c.line&&d.changed.to>b.end.line?(e.push(X(d,c,b.end)),b.file="#0",f=e[0].offsetLines,null!=b.start&&(b.start=t(b.start.line- -f,b.start.ch)),b.end=t(b.end.line-f,b.end.ch)):(e.push({type:"full",name:d.name,text:y(a,d)}),b.file=d.name,d.changed=null):b.file=d.name;for(var h in a.docs)c=a.docs[h],c.changed&&c!=d&&(e.push({type:"full",
name:c.name,text:y(a,c)}),c.changed=null);return{query:b,files:e}}function X(a,d,b){for(var c=a.doc,e=null,f=null,h=d.line-1,l=Math.max(0,h-50);h>=l;--h){var g=c.getLine(h);0>g.search(/\bfunction\b/)||(g=k.countColumn(g,null,4),null!=e&&e<=g||(e=g,f=h))}null==f&&(f=l);h=Math.min(c.lastLine(),b.line+20);if(null==e||e==k.countColumn(c.getLine(d.line),null,4))d=h;else for(d=b.line+1;d<h&&!(g=k.countColumn(c.getLine(d),null,4),g<=e);++d);e=t(f,0);return{type:"part",name:a.name,offsetLines:e.line,text:c.getRange(e,
t(d,0))}}function r(a,d){var b=document.createElement(a);d&&(b.className=d);for(var c=2;c<arguments.length;++c){var e=arguments[c];"string"==typeof e&&(e=document.createTextNode(e));b.appendChild(e)}return b}function L(a,d,b){a.openDialog?a.openDialog(d+": <input type=text>",b):b(prompt(d,""))}function H(a,d){function b(){a.state.ternTooltip=null;e.parentNode&&(a.off("cursorActivity",b),a.off("blur",b),a.off("scroll",b),Y(e))}a.state.ternTooltip&&x(a.state.ternTooltip);var c=a.cursorCoords(),e=a.state.ternTooltip=
B(c.right+1,c.bottom,d),f=!1,h=!1;k.on(e,"mousemove",function(){f=!0});k.on(e,"mouseout",function(a){k.contains(e,a.relatedTarget||a.toElement)||(h?b():f=!1)});setTimeout(function(){h=!0;f||b()},1700);a.on("cursorActivity",b);a.on("blur",b);a.on("scroll",b)}function B(a,d,b){b=r("div",n+"tooltip",b);b.style.left=a+"px";b.style.top=d+"px";document.body.appendChild(b);return b}function x(a){var d=a&&a.parentNode;d&&d.removeChild(a)}function Y(a){a.style.opacity="0";setTimeout(function(){x(a)},1100)}
function u(a,d,b){a.options.showError?a.options.showError(d,b):H(d,String(b))}function A(a){a.activeArgHints&&(x(a.activeArgHints),a.activeArgHints=null)}function y(a,d){var b=d.doc.getValue();a.options.fileFilter&&(b=a.options.fileFilter(b,d.name,d.doc));return b}function Z(a){function d(a,d){d&&(a.id=++c,e[c]=d);b.postMessage(a)}var b=a.worker=new Worker(a.options.workerScript);b.postMessage({type:"init",defs:a.options.defs,plugins:a.options.plugins,scripts:a.options.workerDeps});var c=0,e={};b.onmessage=
function(b){var c=b.data;"getFile"==c.type?C(a,c.name,function(a,b){d({type:"getFile",err:String(a),text:b,id:c.id})}):"debug"==c.type?window.console.log(c.message):c.id&&e[c.id]&&(e[c.id](c.err,c.body),delete e[c.id])};b.onerror=function(a){for(var b in e)e[b](a);e={}};this.addFile=function(a,b){d({type:"add",name:a,text:b})};this.delFile=function(a){d({type:"del",name:a})};this.request=function(a,b){d({type:"req",body:a},b)}}k.TernServer=function(a){var d=this;this.options=a||{};a=this.options.plugins||
(this.options.plugins={});a.doc_comment||(a.doc_comment=!0);this.server=this.options.useWorker?new Z(this):new tern.Server({getFile:function(a,c){return C(d,a,c)},async:!0,defs:this.options.defs||[],plugins:a});this.docs=Object.create(null);this.trackChange=function(a,c){M(d,a,c)};this.activeArgHints=this.cachedArgHints=null;this.jumpStack=[];this.getHint=function(a,c){return N(d,a,c)};this.getHint.async=!0};k.TernServer.prototype={addDoc:function(a,d){var b={doc:d,name:a,changed:null};this.server.addFile(a,
y(this,b));k.on(d,"change",this.trackChange);return this.docs[a]=b},delDoc:function(a){if(a=D(this,a))k.off(a.doc,"change",this.trackChange),delete this.docs[a.name],this.server.delFile(a.name)},hideDoc:function(a){A(this);(a=D(this,a))&&a.changed&&F(this,a)},complete:function(a){a.showHint({hint:this.getHint})},showType:function(a,d,b){G(this,a,d,"type",b)},showDocs:function(a,d,b){G(this,a,d,"documentation",b)},updateArgHints:function(a){P(this,a)},jumpToDef:function(a){R(this,a)},jumpBack:function(a){var d=
this.jumpStack.pop(),b=d&&this.docs[d.file];b&&K(this,v(this,a.getDoc()),b,d.start,d.end)},rename:function(a){T(this,a)},selectName:function(a){V(this,a)},request:function(a,d,b,c){var e=this,f=v(this,a.getDoc()),h=J(this,f,d,c);this.server.request(h,function(a,c){!a&&e.options.responseFilter&&(c=e.options.responseFilter(f,d,h,a,c));b(a,c)})},destroy:function(){this.worker&&(this.worker.terminate(),this.worker=null)}};var t=k.Pos,n="CodeMirror-Tern-",E=250,W=0,z=k.cmpPos});
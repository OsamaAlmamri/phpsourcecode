(function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror"),require("./searchcursor"),require("../scroll/annotatescrollbar")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","./searchcursor","../scroll/annotatescrollbar"],e):e(CodeMirror)})(function(e){function d(a,c,b,e){this.cm=a;var f={listenForChanges:!1},d;for(d in e)f[d]=e[d];f.className||(f.className="CodeMirror-search-match");this.annotation=a.annotateScrollbar(f);this.query=c;this.caseFold=
b;this.gap={from:a.firstLine(),to:a.lastLine()+1};this.matches=[];this.update=null;this.findMatches();this.annotation.update(this.matches);var g=this;a.on("change",this.changeHandler=function(a,b){g.onChange(b)})}function g(a,c,b){return a<=c?a:Math.max(c,a+b)}e.defineExtension("showMatchesOnScrollbar",function(a,c,b){"string"==typeof b&&(b={className:b});b||(b={});return new d(this,a,c,b)});d.prototype.findMatches=function(){if(this.gap){for(var a=0;a<this.matches.length;a++){var c=this.matches[a];
if(c.from.line>=this.gap.to)break;c.to.line>=this.gap.from&&this.matches.splice(a--,1)}for(var b=this.cm.getSearchCursor(this.query,e.Pos(this.gap.from,0),this.caseFold);b.findNext();){c={from:b.from(),to:b.to()};if(c.from.line>=this.gap.to)break;this.matches.splice(a++,0,c);if(1E3<this.matches.length)break}this.gap=null}};d.prototype.onChange=function(a){var c=a.from.line,b=e.changeEnd(a).line,d=b-a.to.line;this.gap?(this.gap.from=Math.min(g(this.gap.from,c,d),a.from.line),this.gap.to=Math.max(g(this.gap.to,
c,d),a.from.line)):this.gap={from:a.from.line,to:b+1};if(d)for(a=0;a<this.matches.length;a++){var b=this.matches[a],f=g(b.from.line,c,d);f!=b.from.line&&(b.from=e.Pos(f,b.from.ch));f=g(b.to.line,c,d);f!=b.to.line&&(b.to=e.Pos(f,b.to.ch))}clearTimeout(this.update);var h=this;this.update=setTimeout(function(){h.updateAfterChange()},250)};d.prototype.updateAfterChange=function(){this.findMatches();this.annotation.update(this.matches)};d.prototype.clear=function(){this.cm.off("change",this.changeHandler);
this.annotation.clear()}});
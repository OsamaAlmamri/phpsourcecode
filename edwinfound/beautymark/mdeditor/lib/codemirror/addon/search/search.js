(function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror"),require("./searchcursor"),require("../dialog/dialog")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","./searchcursor","../dialog/dialog"],e):e(CodeMirror)})(function(e){function t(a,c){"string"==typeof a?a=new RegExp(a.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),c?"gi":"g"):a.global||(a=new RegExp(a.source,a.ignoreCase?"gi":"g"));return{token:function(b){a.lastIndex=b.pos;
var c=a.exec(b.string);if(c&&c.index==b.pos)return b.pos+=c[0].length,"searching";c?b.pos=c.index:b.skipToEnd()}}}function u(){this.overlay=this.posFrom=this.posTo=this.query=null}function k(a){return a.state.search||(a.state.search=new u)}function g(a){return"string"==typeof a&&a==a.toLowerCase()}function h(a,c,b){return a.getSearchCursor(c,b,g(c))}function l(a,c,b,d,f){a.openDialog?a.openDialog(c,f,{value:d}):f(prompt(b,d))}function v(a,c,b,d){if(a.openConfirm)a.openConfirm(c,d);else if(confirm(b))d[0]()}
function p(a){var c=a.match(/^\/(.*)\/([a-z]*)$/);if(c)try{a=new RegExp(c[1],-1==c[2].indexOf("i")?"":"i")}catch(b){}if("string"==typeof a?""==a:a.test(""))a=/x^/;return a}function m(a,c){var b=k(a);if(b.query)return q(a,c);l(a,'Search: <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">(Use /re/ syntax for regexp search)</span>',"Search for:",a.getSelection(),function(d){a.operation(function(){d&&!b.query&&(b.query=p(d),
a.removeOverlay(b.overlay,g(b.query)),b.overlay=t(b.query,g(b.query)),a.addOverlay(b.overlay),a.showMatchesOnScrollbar&&(b.annotate&&(b.annotate.clear(),b.annotate=null),b.annotate=a.showMatchesOnScrollbar(b.query,g(b.query))),b.posFrom=b.posTo=a.getCursor(),q(a,c))})})}function q(a,c){a.operation(function(){var b=k(a),d=h(a,b.query,c?b.posFrom:b.posTo);if(!d.find(c)&&(d=h(a,b.query,c?e.Pos(a.lastLine()):e.Pos(a.firstLine(),0)),!d.find(c)))return;a.setSelection(d.from(),d.to());a.scrollIntoView({from:d.from(),
to:d.to()});b.posFrom=d.from();b.posTo=d.to()})}function n(a){a.operation(function(){var c=k(a);c.query&&(c.query=null,a.removeOverlay(c.overlay),c.annotate&&(c.annotate.clear(),c.annotate=null))})}function r(a,c){a.getOption("readOnly")||l(a,'Replace: <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">(Use /re/ syntax for regexp search)</span>',"Replace:",a.getSelection(),function(b){b&&(b=p(b),l(a,'With: <input type="text" style="width: 10em" class="CodeMirror-search-field"/>',
"Replace with:","",function(d){if(c)a.operation(function(){for(var c=h(a,b);c.findNext();)if("string"!=typeof b){var e=a.getRange(c.from(),c.to()).match(b);c.replace(d.replace(/\$(\d)/g,function(a,b){return e[b]}))}else c.replace(d)});else{n(a);var f=h(a,b,a.getCursor()),e=function(){var c=f.from(),d;if(!(d=f.findNext())&&(f=h(a,b),!(d=f.findNext())||c&&f.from().line==c.line&&f.from().ch==c.ch))return;a.setSelection(f.from(),f.to());a.scrollIntoView({from:f.from(),to:f.to()});v(a,"Replace? <button>Yes</button> <button>No</button> <button>Stop</button>",
"Replace?",[function(){g(d)},e])},g=function(a){f.replace("string"==typeof b?d:d.replace(/\$(\d)/g,function(b,c){return a[c]}));e()};e()}}))})}e.commands.find=function(a){n(a);m(a)};e.commands.findNext=m;e.commands.findPrev=function(a){m(a,!0)};e.commands.clearSearch=n;e.commands.replace=r;e.commands.replaceAll=function(a){r(a,!0)}});
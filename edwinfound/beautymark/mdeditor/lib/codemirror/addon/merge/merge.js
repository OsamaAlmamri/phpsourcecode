(function(q){"object"==typeof exports&&"object"==typeof module?q(require("../../lib/codemirror"),require("diff_match_patch")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","diff_match_patch"],q):q(CodeMirror,diff_match_patch)})(function(q,aa){function B(a,c){this.mv=a;this.type=c;this.classes="left"==c?{chunk:"CodeMirror-merge-l-chunk",start:"CodeMirror-merge-l-chunk-start",end:"CodeMirror-merge-l-chunk-end",insert:"CodeMirror-merge-l-inserted",del:"CodeMirror-merge-l-deleted",
connect:"CodeMirror-merge-l-connect"}:{chunk:"CodeMirror-merge-r-chunk",start:"CodeMirror-merge-r-chunk-start",end:"CodeMirror-merge-r-chunk-end",insert:"CodeMirror-merge-r-inserted",del:"CodeMirror-merge-r-deleted",connect:"CodeMirror-merge-r-connect"}}function C(a){a.diffOutOfDate&&(a.diff=M(a.orig.getValue(),a.edit.getValue()),a.chunks=N(a.diff),a.diffOutOfDate=!1,q.signal(a.edit,"updateDiff",a.diff))}function ba(a){function c(b){y=!0;g=!1;"full"==b&&(a.svg&&D(a.svg),a.copyButtons&&D(a.copyButtons),
H(a.edit,f.marked,a.classes),H(a.orig,k.marked,a.classes),f.from=f.to=k.from=k.to=0);C(a);a.showDifferences&&(O(a.edit,a.diff,f,DIFF_INSERT,a.classes),O(a.orig,a.diff,k,DIFF_DELETE,a.classes));z(a);"align"==a.mv.options.connect&&I(a);y=!1}function b(b){y||(a.dealigned=!0,e(b))}function e(a){y||g||(clearTimeout(h),!0===a&&(g=!0),h=setTimeout(c,!0===a?20:250))}function d(c,e){a.diffOutOfDate||(a.diffOutOfDate=!0,f.from=f.to=k.from=k.to=0);b(e.text.length-1!=e.to.line-e.from.line)}var f={from:0,to:0,
marked:[]},k={from:0,to:0,marked:[]},h,g=!1;a.edit.on("change",d);a.orig.on("change",d);a.edit.on("markerAdded",b);a.edit.on("markerCleared",b);a.orig.on("markerAdded",b);a.orig.on("markerCleared",b);a.edit.on("viewportChange",function(){e(!1)});a.orig.on("viewportChange",function(){e(!1)});c();return c}function ca(a){a.edit.on("scroll",function(){J(a,DIFF_INSERT)&&z(a)});a.orig.on("scroll",function(){J(a,DIFF_DELETE)&&z(a)})}function J(a,c){var b,e;if(a.diffOutOfDate)return!1;if(!a.lockScroll)return!0;
var d,f,k=+new Date;c==DIFF_INSERT?(d=a.edit,f=a.orig):(d=a.orig,f=a.edit);if(d.state.scrollSetBy==a&&(d.state.scrollSetAt||0)+50>k)return!1;var h=d.getScrollInfo();if("align"==a.mv.options.connect)l=h.top;else{var g=.5*h.clientHeight,l=h.top+g;b=d.lineAtHeight(l,"local");for(var m=a.chunks,t=c==DIFF_INSERT,u,r,n,p=0;p<m.length;p++){var v=m[p],P=t?v.editFrom:v.origFrom,q=t?v.editTo:v.origTo;null==r&&(P>b?(r=v.editFrom,n=v.origFrom):q>b&&(r=v.editTo,n=v.origTo));q<=b?(u=v.editTo,e=v.origTo):P<=b&&
(u=v.editFrom,e=v.origFrom)}b={before:u,after:r};e={before:e,after:n};d=Q(d,c==DIFF_INSERT?b:e);e=Q(f,c==DIFF_INSERT?e:b);var l=e.top-g+(l-d.top)/(d.bot-d.top)*(e.bot-e.top),A;l>h.top&&1>(A=h.top/g)?l=l*A+h.top*(1-A):(d=h.height-h.clientHeight-h.top)<g&&(e=f.getScrollInfo(),e.height-e.clientHeight-l>d&&1>(A=d/g)&&(l=l*A+(e.height-e.clientHeight-d)*(1-A)))}f.scrollTo(h.left,l);f.state.scrollSetAt=k;f.state.scrollSetBy=a;return!0}function Q(a,c){var b=c.after;null==b&&(b=a.lastLine()+1);return{top:a.heightAtLine(c.before||
0,"local"),bot:a.heightAtLine(b,"local")}}function R(a,c,b){(a.lockScroll=c)&&0!=b&&J(a,DIFF_INSERT)&&z(a);a.lockButton.innerHTML=c?"\u21db\u21da":"\u21db&nbsp;&nbsp;\u21da"}function H(a,c,b){for(var e=0;e<c.length;++e){var d=c[e];d instanceof q.TextMarker?d.clear():d.parent&&(a.removeLineClass(d,"background",b.chunk),a.removeLineClass(d,"background",b.start),a.removeLineClass(d,"background",b.end))}c.length=0}function O(a,c,b,e,d){var f=a.getViewport();a.operation(function(){b.from==b.to||20<f.from-
b.to||20<b.from-f.to?(H(a,b.marked,d),K(a,c,e,b.marked,f.from,f.to,d),b.from=f.from,b.to=f.to):(f.from<b.from&&(K(a,c,e,b.marked,f.from,b.from,d),b.from=f.from),f.to>b.to&&(K(a,c,e,b.marked,b.to,f.to,d),b.to=f.to))})}function K(a,c,b,e,d,f,k){function h(b,c){for(var g=Math.max(d,b),h=Math.min(f,c),l=g;l<h;++l){var m=a.addLineClass(l,"background",k.chunk);l==b&&a.addLineClass(m,"background",k.start);l==c-1&&a.addLineClass(m,"background",k.end);e.push(m)}b==c&&g==c&&h==c&&(g?e.push(a.addLineClass(g-
1,"background",k.end)):e.push(a.addLineClass(g,"background",k.start)))}for(var g=w(0,0),l=w(d,0),m=a.clipPos(w(f-1)),t=b==DIFF_DELETE?k.del:k.insert,u=0,r=0;r<c.length;++r){var n=c[r],p=n[0],n=n[1];p==DIFF_EQUAL?(p=g.line+(S(c,r)?0:1),E(g,n),n=g.line+(T(c,r)?1:0),n>p&&(r&&h(u,p),u=n)):p==b&&(p=E(g,n,!0),g=0<(l.line-g.line||l.ch-g.ch)?l:g,n=0>(m.line-p.line||m.ch-p.ch)?m:p,g.line==n.line&&g.ch==n.ch||e.push(a.markText(g,n,{className:t})),g=p)}u<=g.line&&h(u,g.line+1)}function z(a){if(a.showDifferences){if(a.svg){D(a.svg);
var c=a.gap.offsetWidth;U(a.svg,"width",c,"height",a.gap.offsetHeight)}a.copyButtons&&D(a.copyButtons);for(var b=a.edit.getViewport(),e=a.orig.getViewport(),d=a.edit.getScrollInfo().top,f=a.orig.getScrollInfo().top,k=0;k<a.chunks.length;k++){var h=a.chunks[k];if(h.editFrom<=b.to&&h.editTo>=b.from&&h.origFrom<=e.to&&h.origTo>=e.from){var g=a,l=f,m=d,t=c,u="left"==g.type,r=g.orig.heightAtLine(h.origFrom,"local")-l;if(g.svg){var n=r,p=g.edit.heightAtLine(h.editFrom,"local")-m;if(u)var v=n,n=p,p=v;var l=
g.orig.heightAtLine(h.origTo,"local")-l,q=g.edit.heightAtLine(h.editTo,"local")-m;u&&(v=l,l=q,q=v);u=" C "+t/2+" "+p+" "+t/2+" "+n+" "+(t+2)+" "+n;n=" C "+t/2+" "+l+" "+t/2+" "+q+" -1 "+q;U(g.svg.appendChild(document.createElementNS("http://www.w3.org/2000/svg","path")),"d","M -1 "+p+u+" L "+(t+2)+" "+l+n+" z","class",g.classes.connect)}g.copyButtons&&(t=g.copyButtons.appendChild(x("div","left"==g.type?"\u21dd":"\u21dc","CodeMirror-merge-copy")),p=g.mv.options.allowEditingOriginals,t.title=p?"Push to left":
"Revert chunk",t.chunk=h,t.style.top=r+"px",p&&(m=g.orig.heightAtLine(h.editFrom,"local")-m,r=g.copyButtons.appendChild(x("div","right"==g.type?"\u21dd":"\u21dc","CodeMirror-merge-copy-reverse")),r.title="Push to right",r.chunk={editFrom:h.origFrom,editTo:h.origTo,origFrom:h.editFrom,origTo:h.editTo},r.style.top=m+"px","right"==g.type?r.style.left="2px":r.style.right="2px"))}}}}function F(a,c){for(var b=0,e=0,d=0;d<c.length;d++){var f=c[d];if(f.editTo>a&&f.editFrom<=a)return null;if(f.editFrom>a)break;
b=f.editTo;e=f.origTo}return e+(a-b)}function da(a,c){for(var b=[],e=0;e<a.chunks.length;e++){var d=a.chunks[e];b.push([d.origTo,d.editTo,c?F(d.editTo,c.chunks):null])}if(c)for(e=0;e<c.chunks.length;e++){for(var d=c.chunks[e],f=0;f<b.length;f++){var k=b[f];if(k[1]==d.editTo){f=-1;break}else if(k[1]>d.editTo)break}-1<f&&b.splice(f-1,0,[F(d.editTo,a.chunks),d.editTo,d.origTo])}return b}function I(a,c){if(a.dealigned||c){if(!a.orig.curOp)return a.orig.operation(function(){I(a,c)});a.dealigned=!1;var b=
a.mv.left==a?a.mv.right:a.mv.left;b&&(C(b),b.dealigned=!1);for(var e=da(a,b),d=a.mv.aligners,f=0;f<d.length;f++)d[f].clear();d.length=0;var k=[a.orig,a.edit],h=[];b&&k.push(b.orig);for(f=0;f<k.length;f++)h.push(k[f].getScrollInfo().top);for(b=0;b<e.length;b++)ea(k,e[b],d);for(f=0;f<k.length;f++)k[f].scrollTo(null,h[f])}}function ea(a,c,b){for(var e=0,d=[],f=0;f<a.length;f++)if(null!=c[f]){var k=a[f].heightAtLine(c[f],"local");d[f]=k;e=Math.max(e,k)}for(f=0;f<a.length;f++)null!=c[f]&&(k=e-d[f],1<k&&
b.push(fa(a[f],c[f],k)))}function fa(a,c,b){var e=!0;c>a.lastLine()&&(c--,e=!1);var d=document.createElement("div");d.className="CodeMirror-merge-spacer";d.style.height=b+"px";d.style.minWidth="1px";return a.addLineWidget(c,d,{height:b,above:e})}function V(a,c,b,e){a.diffOutOfDate||c.replaceRange(b.getRange(w(e.origFrom,0),w(e.origTo,0)),w(e.editFrom,0),w(e.editTo,0))}function W(a){var c=a.lockButton=x("div",null,"CodeMirror-merge-scrolllock");c.title="Toggle locked scrolling";var b=x("div",[c],"CodeMirror-merge-scrolllock-wrap");
q.on(c,"click",function(){R(a,!a.lockScroll)});c=[b];!1!==a.mv.options.revertButtons&&(a.copyButtons=x("div",null,"CodeMirror-merge-copybuttons-"+a.type),q.on(a.copyButtons,"click",function(b){b=b.target||b.srcElement;b.chunk&&("CodeMirror-merge-copy-reverse"==b.className?V(a,a.orig,a.edit,b.chunk):V(a,a.edit,a.orig,b.chunk))}),c.unshift(a.copyButtons));"align"!=a.mv.options.connect&&((b=document.createElementNS&&document.createElementNS("http://www.w3.org/2000/svg","svg"))&&!b.createSVGRect&&(b=
null),(a.svg=b)&&c.push(b));return a.gap=x("div",c,"CodeMirror-merge-gap")}function X(a){return"string"==typeof a?a:a.getValue()}function M(a,c){var b=Y.diff_main(a,c);Y.diff_cleanupSemantic(b);for(var e=0;e<b.length;++e){var d=b[e];d[1]?e&&b[e-1][0]==d[0]&&(b.splice(e--,1),b[e][1]+=d[1]):b.splice(e--,1)}return b}function N(a){for(var c=[],b=0,e=0,d=w(0,0),f=w(0,0),k=0;k<a.length;++k){var h=a[k],g=h[0];if(g==DIFF_EQUAL){var l=S(a,k)?0:1,g=d.line+l,l=f.line+l;E(d,h[1],null,f);var m=T(a,k)?1:0,h=d.line+
m,m=f.line+m;h>g&&(k&&c.push({origFrom:e,origTo:l,editFrom:b,editTo:g}),b=h,e=m)}else E(g==DIFF_INSERT?d:f,h[1])}(b<=d.line||e<=f.line)&&c.push({origFrom:e,origTo:f.line+1,editFrom:b,editTo:d.line+1});return c}function T(a,c){if(c==a.length-1)return!0;var b=a[c+1][1];if(1==b.length||10!=b.charCodeAt(0))return!1;if(c==a.length-2)return!0;b=a[c+2][1];return 1<b.length&&10==b.charCodeAt(0)}function S(a,c){if(0==c)return!0;var b=a[c-1][1];if(10!=b.charCodeAt(b.length-1))return!1;if(1==c)return!0;b=a[c-
2][1];return 10==b.charCodeAt(b.length-1)}function ga(a,c,b){function e(){f.clear();a.removeLineClass(c,"wrap","CodeMirror-merge-collapsed-line")}a.addLineClass(c,"wrap","CodeMirror-merge-collapsed-line");var d=document.createElement("span");d.className="CodeMirror-merge-collapsed-widget";d.title="Identical text collapsed. Click to expand.";var f=a.markText(w(c,0),w(b-1),{inclusiveLeft:!0,inclusiveRight:!0,replacedWith:d,clearOnEnter:!0});d.addEventListener("click",e);return{mark:f,clear:e}}function ha(a,
c){function b(){for(var a=0;a<e.length;a++)e[a].clear()}for(var e=[],d=0;d<c.length;d++){var f=c[d],f=ga(f.cm,f.line,f.line+a);e.push(f);f.mark.on("clear",b)}return e[0].mark}function Z(a,c,b,e){for(var d=0;d<a.chunks.length;d++)for(var f=a.chunks[d],k=f.editFrom-c;k<f.editTo+c;k++){var h=k+b;0<=h&&h<e.length&&(e[h]=!1)}}function x(a,c,b,e){a=document.createElement(a);b&&(a.className=b);e&&(a.style.cssText=e);if("string"==typeof c)a.appendChild(document.createTextNode(c));else if(c)for(b=0;b<c.length;++b)a.appendChild(c[b]);
return a}function D(a){for(var c=a.childNodes.length;0<c;--c)a.removeChild(a.firstChild)}function U(a){for(var c=1;c<arguments.length;c+=2)a.setAttribute(arguments[c],arguments[c+1])}function L(a,c){c||(c={});for(var b in a)a.hasOwnProperty(b)&&(c[b]=a[b]);return c}function E(a,c,b,e){a=b?w(a.line,a.ch):a;for(b=0;;){var d=c.indexOf("\n",b);if(-1==d)break;++a.line;e&&++e.line;b=d+1}a.ch=(b?0:a.ch)+(c.length-b);e&&(e.ch=(b?0:e.ch)+(c.length-b));return a}var w=q.Pos;B.prototype={constructor:B,init:function(a,
c,b){this.edit=this.mv.edit;this.orig=q(a,L({value:c,readOnly:!this.mv.options.allowEditingOriginals},L(b)));this.diff=M(X(c),X(b.value));this.chunks=N(this.diff);this.diffOutOfDate=this.dealigned=!1;this.showDifferences=!1!==b.showDifferences;this.forceUpdate=ba(this);R(this,!0,!1);ca(this)},setShowDifferences:function(a){a=!1!==a;a!=this.showDifferences&&(this.showDifferences=a,this.forceUpdate("full"))}};var y=!1,G=q.MergeView=function(a,c){if(!(this instanceof G))return new G(a,c);this.options=
c;var b=c.origLeft,e=null==c.origRight?c.orig:c.origRight,d=null!=b,f=null!=e,k=1+(d?1:0)+(f?1:0),h=[],g=this.left=null,l=this.right=null,m=this;if(d){var g=this.left=new B(this,"left"),t=x("div",null,"CodeMirror-merge-pane");h.push(t);h.push(W(g))}d=x("div",null,"CodeMirror-merge-pane");h.push(d);if(f){l=this.right=new B(this,"right");h.push(W(l));var u=x("div",null,"CodeMirror-merge-pane");h.push(u)}(f?u:d).className+=" CodeMirror-merge-pane-rightmost";h.push(x("div",null,null,"height: 0; clear: both;"));
var r=this.wrap=a.appendChild(x("div",h,"CodeMirror-merge CodeMirror-merge-"+k+"pane"));this.edit=q(d,L(c));g&&g.init(t,b,c);l&&l.init(u,e,c);c.collapseIdentical&&(y=!0,this.editor().operation(function(){var a=c.collapseIdentical;"number"!=typeof a&&(a=2);for(var b=[],e=m.editor(),f=e.firstLine(),d=f,g=e.lastLine();d<=g;d++)b.push(!0);m.left&&Z(m.left,a,f,b);m.right&&Z(m.right,a,f,b);for(d=0;d<b.length;d++)if(b[d]){for(var g=d+f,h=1;d<b.length-1&&b[d+1];d++,h++);if(h>a){var k=[{line:g,cm:e}];m.left&&
k.push({line:F(g,m.left.chunks),cm:m.left.orig});m.right&&k.push({line:F(g,m.right.chunks),cm:m.right.orig});k=ha(h,k);if(m.options.onCollapse)m.options.onCollapse(m,g,h,k)}}}),y=!1);"align"==c.connect&&(this.aligners=[],I(this.left||this.right,!0));var n=function(){g&&z(g);l&&z(l)};q.on(window,"resize",n);var p=setInterval(function(){for(var a=r.parentNode;a&&a!=document.body;a=a.parentNode);a||(clearInterval(p),q.off(window,"resize",n))},5E3)};G.prototype={constuctor:G,editor:function(){return this.edit},
rightOriginal:function(){return this.right&&this.right.orig},leftOriginal:function(){return this.left&&this.left.orig},setShowDifferences:function(a){this.right&&this.right.setShowDifferences(a);this.left&&this.left.setShowDifferences(a)},rightChunks:function(){if(this.right)return C(this.right),this.right.chunks},leftChunks:function(){if(this.left)return C(this.left),this.left.chunks}};var Y=new aa});
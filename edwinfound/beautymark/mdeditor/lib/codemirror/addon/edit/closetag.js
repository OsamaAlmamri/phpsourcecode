(function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror"),require("../fold/xml-fold")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","../fold/xml-fold"],e):e(CodeMirror)})(function(e){function r(c){if(c.getOption("disableInput"))return e.Pass;for(var g=c.listSelections(),a=[],d=0;d<g.length;d++){if(!g[d].empty())return e.Pass;var f=g[d].head,b=c.getTokenAt(f),l=e.innerMode(c.getMode(),b.state),m=l.state;if("xml"!=l.mode.name||!m.tagName)return e.Pass;
var h=c.getOption("autoCloseTags"),k="html"==l.mode.configuration,l="object"==typeof h&&h.dontCloseTags||k&&t,k="object"==typeof h&&h.indentTags||k&&u,h=m.tagName;b.end>f.ch&&(h=h.slice(0,h.length-b.end+f.ch));var n=h.toLowerCase();if(!h||"string"==b.type&&(b.end!=f.ch||!/[\"\']/.test(b.string.charAt(b.string.length-1))||1==b.string.length)||"tag"==b.type&&"closeTag"==m.type||b.string.indexOf("/")==b.string.length-1||l&&-1<p(l,n)||q(c,h,f,m,!0))return e.Pass;b=k&&-1<p(k,n);a[d]={indent:b,text:">"+
(b?"\n\n":"")+"</"+h+">",newPos:b?e.Pos(f.line+1,0):e.Pos(f.line,f.ch+1)}}for(d=g.length-1;0<=d;d--)f=a[d],c.replaceRange(f.text,g[d].head,g[d].anchor,"+insert"),b=c.listSelections().slice(0),b[d]={head:f.newPos,anchor:f.newPos},c.setSelections(b),f.indent&&(c.indentLine(f.newPos.line,null,!0),c.indentLine(f.newPos.line+1,null,!0))}function n(c,g){for(var a=c.listSelections(),d=[],f=g?"/":"</",b=0;b<a.length;b++){if(!a[b].empty())return e.Pass;var l=a[b].head,m=c.getTokenAt(l),h=e.innerMode(c.getMode(),
m.state),k=h.state;if(g&&("string"==m.type||"<"!=m.string.charAt(0)||m.start!=l.ch-1))return e.Pass;if("xml"!=h.mode.name)if("htmlmixed"==c.getMode().name&&"javascript"==h.mode.name)d[b]=f+"script>";else if("htmlmixed"==c.getMode().name&&"css"==h.mode.name)d[b]=f+"style>";else return e.Pass;else{if(!k.context||!k.context.tagName||q(c,k.context.tagName,l,k))return e.Pass;d[b]=f+k.context.tagName+">"}}c.replaceSelections(d);a=c.listSelections();for(b=0;b<a.length;b++)(b==a.length-1||a[b].head.line<
a[b+1].head.line)&&c.indentLine(a[b].head.line)}function p(c,e){if(c.indexOf)return c.indexOf(e);for(var a=0,d=c.length;a<d;++a)if(c[a]==e)return a;return-1}function q(c,g,a,d,f){if(!e.scanForClosingTag)return!1;var b=Math.min(c.lastLine()+1,a.line+500);a=e.scanForClosingTag(c,a,null,b);if(!a||a.tag!=g)return!1;d=d.context;for(f=f?1:0;d&&d.tagName==g;d=d.prev)++f;a=a.to;for(d=1;d<f;d++){a=e.scanForClosingTag(c,a,null,b);if(!a||a.tag!=g)return!1;a=a.to}return!0}e.defineOption("autoCloseTags",!1,function(c,
g,a){a!=e.Init&&a&&c.removeKeyMap("autoCloseTags");if(g){a={name:"autoCloseTags"};if("object"!=typeof g||g.whenClosing)a["'/'"]=function(a){a=a.getOption("disableInput")?e.Pass:n(a,!0);return a};if("object"!=typeof g||g.whenOpening)a["'>'"]=function(a){return r(a)};c.addKeyMap(a)}});var t="area base br col command embed hr img input keygen link meta param source track wbr".split(" "),u="applet blockquote body button div dl fieldset form frameset h1 h2 h3 h4 h5 h6 head html iframe layer legend object ol p select table ul".split(" ");
e.commands.closeTag=function(c){return n(c)}});
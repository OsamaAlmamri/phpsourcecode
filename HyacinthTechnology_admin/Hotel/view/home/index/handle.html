<!DOCTYPE html>
<html class="x-admin-sm">

{include file="common/static" /}
{include file="common/resources" /}
    <body>
        <div class="x-nav">
            <span class="layui-breadcrumb">
                <a href="">首页</a>
                <a href="">演示</a>
                <a>
                    <cite>导航元素</cite></a>
            </span>
            <a class="layui-btn layui-btn-small" style="line-height:1.6em;margin-top:3px;float:right" onclick="location.reload()" title="刷新">
                <i class="layui-icon layui-icon-refresh" style="line-height:30px"></i>
            </a>
        </div>
        <div class="layui-fluid" id="app">
            <div class="layui-row layui-col-space15">
                <div class="layui-col-md12">
                    <div class="layui-card">

                        <div class="layui-card-header">
                            <a class="layui-btn" href="{:url('home/index/welcome')}">
                                <i class="layui-icon"></i>返回房态
                            </a>
                            <button class="layui-btn" onclick="xadmin.open('随客管理','/home/index/peers/room_id/{$list.id}',1000,700)">
                                <i class="layui-icon"></i>随客管理
                            </button>
                            <a class="layui-btn" href="/home/invoice/into_house/id/{$list.id}">
                                <i class="layui-icon"></i>打印单据
                            </a>
                        </div>
                        <div class="layui-card-body ">


                            <table class="layui-table" lay-skin="line">
                                <tbody>
                                <tr>
                                    <td>
                                        <div class="layui-form-item">
                                            <label class="layui-form-label">主客姓名</label>
                                            <div class="layui-input-inline">
                                                <input type="text" id="guest_name" value="{$list.guest_name}" required lay-verify="required" placeholder="请输入姓名" autocomplete="off" class="layui-input">
                                            </div>
                                            <div class="layui-form-mid layui-word-aux">
                                                <a href="#myModal" role="button" class="btn icon iconfont" data-toggle="modal">会员</a>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <form class="layui-form" action="">
                                            <div class="layui-form-item">
                                                <label class="layui-form-label">促销活动</label>
                                                <div class="layui-input-block">
                                                    <select name="city" lay-verify="required" id="activity_id">
                                                        {volist name="activity" id="vo"}
                                                            <option value={$vo.id}>{$vo.name}</option>
                                                        {/volist}
                                                    </select>
                                                </div>
                                            </div>
                                        </form>

                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <form class="layui-form" action="">
                                            <div class="layui-form-item" style="width: 240px;float: left;">
                                                <label class="layui-form-label">证件类型</label>
                                                <div class="layui-input-block">
                                                    <select name="city" lay-verify="required" >
                                                        {volist name="identity" id="v"}
                                                        <option value={$v.id}>{$v.identity}</option>
                                                        {/volist}
                                                    </select>
                                                </div>
                                            </div>
                                        </form>
                                        <div class="layui-form-item" >
                                            <label class="layui-form-label">证件号码</label>
                                            <div class="layui-input-inline">
                                                <input type="text" id="credentials" value="{$list.credentials}" required lay-verify="required" placeholder="请输入密码" autocomplete="off" class="layui-input">
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <form class="layui-form" action="">
                                            <div class="layui-form-item" style="width: 300px;float: left;">
                                                <label class="layui-form-label">宾客性别</label>
                                                <div class="layui-input-block">
                                                    <select name="city" lay-verify="required" id="guest_sex">
                                                        <option value="0">男</option>
                                                        <option value="1">女</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </form>
                                        <form class="layui-form" action="">
                                            <div class="layui-form-item" style="width: 300px;float: right;margin-top: -55px;margin-right: 440px;">
                                                <label class="layui-form-label">宾客来源</label>
                                                <div class="layui-input-block">
                                                    <select name="city" lay-verify="required" id="guest_source">
                                                        {volist name="guest" id="vv"}
                                                            <option value={$vv.id}>{$vv.guest}</option>
                                                        {/volist}
                                                    </select>
                                                </div>
                                            </div>
                                        </form>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <div class="layui-form-item">
                                            <label class="layui-form-label">宾客人数</label>
                                            <div class="layui-input-inline">
                                                <input type="text" id="guest_number" required lay-verify="required" placeholder="请输入密码" autocomplete="off" class="layui-input">
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="layui-form-item" >
                                            <label class="layui-form-label">预住时长</label>
                                            <div class="layui-input-inline">
                                                <input type="text" id="move_duration" required lay-verify="required" placeholder="请输入密码" autocomplete="off" class="layui-input">
                                            </div>
                                        </div>

                                        <div class="layui-input-inline layui-show-xs-block" style="width: 200px;float: left;margin-left: 350px;margin-top: -60px;">
                                            <input class="layui-input" placeholder="预离时间" name="end" id="end">
                                        </div>

                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <form class="layui-form" action="">
                                            <div class="layui-form-item">
                                                <label class="layui-form-label">收款方式</label>
                                                <div class="layui-input-block">
                                                    <select name="city" lay-verify="required" id="payment_id">
                                                        {volist name="payment" id="v1"}
                                                        <option value={$v1.id}>{$v1.pay_name}</option>
                                                        {/volist}
                                                    </select>
                                                </div>
                                            </div>
                                        </form>
                                            <input type="text" id="member_id" value="0">

                                    </td>

                                </tr>
                                </tbody>
                            </table>


<!----------------------------------------------------------------------------------------------------------------->
                            <div class="layui-card-header">
                                <button class="layui-btn" onclick="xadmin.open('添加用户','/home/index/addroom/room_id/{$list.id}',800,600)">
                                    <i class="layui-icon"></i>追加房间
                                </button>
<!--                                <button class="layui-btn" onclick="xadmin.open('添加用户','/index/storeys/adds',500,200)">
                                    <i class="layui-icon"></i>移除房间
                                </button>-->
                                <button class="layui-btn" onclick="adds({$list.id})">
                                    <i class="layui-icon"></i>确定保存
                                </button>
                                <a class="layui-btn" href="/home/invoice/bill/id/{$list.id}">
                                    <i class="layui-icon"></i>查看票据
                                </a>
                                <span>主客房间：{$list.room_num}</span>
                            </div>
                            <table class="layui-table">
                                <colgroup>
                                    <col width="150">
                                    <col width="200">
                                    <col>
                                </colgroup>
                                <thead>
                                <tr>
                                    <th>房间号</th>
                                    <th>房间类型</th>
                                    <th>房间价格</th>
                                    <th>定金</th>
                                    <th>楼层</th>
                                    <th>预离时间</th>
                                    <th>操作</th>
                                </tr>
                                </thead>
                                <tbody>
<!--                                <tr>
                                    <td>{$list.room_num}</td>
                                    <td>游戏间</td>
                                    <td>168￥</td>
                                    <td>2016-11-29</td>
                                </tr>-->
                                {volist name="show" id="vo"}
                                <tr>
                                    <td>{$vo.room_num}</td>
                                    <td>{$vo.type_name}</td>
                                    <td>{$vo.price}</td>
                                    <td>{$vo.deposit}</td>
                                    <td>{$vo.storey}</td>
                                    <td>2016-11-29</td>
                                    <td class="td-manage">
                                        <a title="删除" onclick="member_del(this,{$vo.id})" href="javascript:;">
                                            <i class="layui-icon">&#xe640;</i>
                                        </a>
                                    </td>
                                </tr>
                                {/volist}
                                </tbody>
                            </table>

                        </div>

                    </div>
                </div>
            </div>
        </div>


        <!-- Modal -->
        <div id="myModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                <h3 id="myModalLabel">会员</h3>
            </div>
            <div class="modal-body">

                <table class="layui-table layui-form">
                    <thead>
                    <tr>
                        <th>ID</th>
                        <th>会员</th>
                        <th>证据号码</th>
                        <th>操作</th></tr>
                    </thead>
                    <tbody>
                    {volist name="member" id="m"}
                    <tr>
                        <td>{$m.id}</td>
                        <td>{$m.name}</td>
                        <td>{$m.identity}</td>
                        <td class="td-manage">
                            <a title="查看" onclick="member({$m.id})" href="javascript:;">
                                <i class="layui-icon">&#xe63c;</i>选择
                            </a>
                        </td>
                    </tr>
                    {/volist}
                    </tbody>
                </table>

            </div>
            <div class="modal-footer">
                <button class="btn" data-dismiss="modal" aria-hidden="true">关闭</button>
            </div>
        </div>




    </body>
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script>
    //Demo
    layui.use('form', function(){
        var form = layui.form;

        //监听提交
        form.on('submit(formDemo)', function(data){
            layer.msg(JSON.stringify(data.field));
            return false;
        });
    });
    layui.use(['laydate', 'form'],
            function() {
                var laydate = layui.laydate;

                //执行一个laydate实例
                laydate.render({
                    elem: '#end' //指定元素
                });
            });
    $('#myModal').show();
    ws = new WebSocket("ws://127.0.0.1:8282");

    /*
    * 办理入住
    * */
    function adds(id){
        $.ajax({
            type:"post",
            url: "{:url('home/index/handle')}",
            data: {
                id:id,
                payment_id:$('#payment_id').val(),
                guest_name:$('#guest_name').val(),
                activity_id:$('#activity_id').val(),
                credentials:$('#credentials').val(),
                guest_sex:$('#guest_sex').val(),
                guest_source:$('#guest_source').val(),
                guest_number:$('#guest_number').val(),
                move_duration:$('#move_duration').val(),
                move_time:$('#end').val(),
                status:2,
                member_id:$('#member_id').val()
            },
            success: function(data){
                console.log(data);
                toastr.error(data.msg);
                if(data.code == 100){
                    // 假设服务端ip为127.0.0.1
                    ws = new WebSocket("ws://127.0.0.1:8282");
                    ws.onopen = function() {

                        //右下弹出
                        layer.open({
                            type: 1
                            ,offset: 'rb'
                            ,content: '<div style="padding: 20px 80px;">入住成功</div>'
                            ,btn: '关闭全部'
                            ,btnAlign: 'c' //按钮居中
                            ,shade: 0 //不显示遮罩
                            ,anim: 2
                            ,yes: function(){
                                layer.closeAll();
                            }
                        });

                        var audio= new Audio("/static/voice/2/welcome.mp3");

                        audio.play();//播放
                        ws.send('tom');

                    };
                    ws.onmessage = function(e) {
                        // alert("收到服务端的消息：" + e.data);
                        console.log("收到服务端的消息：" + e.data);
                    };

                    setTimeout(function () {
                        // window.location.href="{:url('/home/index/bill/id/')}"+id;
                    },4000);
                }
            }});
    }

    /*会员选择*/
    function member(id) {
        $.ajax({
            type:"post",
            url: "{:url('home/index/select_member')}",
            data: {
                id:id,
            },
            success: function(data){
                console.log(data);
                console.log(data.name);
                $('#guest_name').val(data.name);
                $('#credentials').val(data.identity);
                $('#member_id').val(data.id);
                // $('#myModal').hide();
            }});
    }

    /*房间移除*/
    function member_del(obj, id) {
        layer.confirm('确认要删除吗？',
                function(index) {
                    $.ajax({
                        type:"post",
                        url: "{:url('/home/index/remove')}",
                        data: {
                            id:id
                        },
                        success: function(data){
                            console.log(data);
                            toastr.error(data.msg);
                            if(data.code == 100){

                                layer.closeAll();
                                $(obj).parents("tr").remove();
                                setTimeout(function () {
                                    // location.reload();
                                },1000);
                            }
                        }});
                });
    }


</script>
</html>
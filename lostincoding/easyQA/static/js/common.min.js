if(typeof Pjax != 'undefined'){
    pjax_init();
}
//初始化pjax
function pjax_init(){
    document.addEventListener('pjax:send', function() {
        NProgress.start();
    });

    document.addEventListener('pjax:complete', function() {
        NProgress.done();
    });

    document.addEventListener('pjax:error', function() {

    });

    document.addEventListener('pjax:success', function() {

    });

    document.addEventListener('DOMContentLoaded', function() {
        var pjax = new Pjax({
            elements: 'a.pjax',
            selectors: [
                'title',
                '#header',
                '#main'
            ]
        });
    });
}

/*******************************************我是华丽的分割线****************************************************/

String.prototype.trim = function(){
    return this.replace(/(^\s*)|(\s*$)/g, "");
}
String.prototype.ltrim = function(){
    return this.replace(/(^\s*)/g,"");
}
String.prototype.rtrim = function(){
    return this.replace(/(\s*$)/g,"");
}

//xss过滤
function xss_filter(str){
    //return str
    //        .replace(/&/g, "&amp;")
    //        .replace(/</g, "&lt;")
    //        .replace(/>/g, "&gt;")
    //        .replace(/"/g, "&quot;")
    //        .replace(/'/g, "&acute;");
    return str
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");
}

//xss过滤
function content_xss_filter(str){
    str = xss_filter(str);

    //[code][/code]
    str = str.replace(
        /\[code\]([\s\S]*?)\[\/code\]\s*/gi,
        function (match) {
            //替换换行符，防止代码高亮的时候多出空行
            return match.replace(/[\n\r]+/, "\n");
        }
    );
    str = str.replace(/\[code\]([\s\S]*?)\[\/code\]\s*/gi, '<pre><code>$1</code></pre>\n');

    //替换url
    str = str.replace('/(?i)\b((?:https?:\/\/|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,4}\/)(?:[^\s()<>]+|\(([^\s()<>]+|(\([^\s()<>]+\)))*\))+(?:\(([^\s()<>]+|(\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:\'".,<>?«»“”‘’]))/is', '<a href="$1" target="_blank">$1</a>');

    //[img][/img]上传的图片
    str = str.replace(/\[img\](.*?)\[\/img\]\s*/gi, '<div class="photo"><img src="http://' + CONFIG['qiniu']['static_bucket_domain'] + '/$1"></div>');

    //替换#话题#
    str = str.replace(
        /#[\u4e00-\u9fa5a-zA-Z0-9-\+\.,]+?#/gi,
        function (match) {
            //长度超过了则不替换
            if (mix_strlen(match) <= 20) {
                var topic = match.replace(/#/gi, '');
                return match.replace(/(#[\u4e00-\u9fa5a-zA-Z0-9-\+\.,]+?#)/gi, '<a href="/topic/articles?topic=' + encodeURI(topic) + '" target="_blank">$1</a>');
            } else {
                return match;
            }
        }
    );

    //替换@用户昵称
    str = str.replace(
        /@[\u4e00-\u9fa5a-zA-Z0-9-]+/gi,
        function (match) {
            //长度超过了则不替换
            if (mix_strlen(match) <= 20) {
                var nickname = match.replace(/@/gi, '');
                return match.replace(/(@[\u4e00-\u9fa5a-zA-Z0-9-]+)/gi, '<a href="/u/home?nickname=' + encodeURI(nickname) + '" target="_blank">$1</a>');
            } else {
                return match;
            }
        }
    );

    //替换表情
    var face_arr = {
        '微笑' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/5c/huanglianwx_thumb.gif',
        '嘻嘻' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/0b/tootha_thumb.gif',
        '哈哈' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/6a/laugh.gif',
        '可爱' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/14/tza_thumb.gif',
        '可怜' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/af/kl_thumb.gif',
        '挖鼻' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/0b/wabi_thumb.gif',
        '吃惊' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/f4/cj_thumb.gif',
        '害羞' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/6e/shamea_thumb.gif',
        '挤眼' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/c3/zy_thumb.gif',
        '闭嘴' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/29/bz_thumb.gif',
        '鄙视' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/71/bs2_thumb.gif',
        '爱你' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/6d/lovea_thumb.gif',
        '泪' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/9d/sada_thumb.gif',
        '偷笑' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/19/heia_thumb.gif',
        '亲亲' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/8f/qq_thumb.gif',
        '生病' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/b6/sb_thumb.gif',
        '太开心' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/58/mb_thumb.gif',
        '白眼' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/d9/landeln_thumb.gif',
        '右哼哼' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/98/yhh_thumb.gif',
        '左哼哼' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/6d/zhh_thumb.gif',
        '嘘' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/a6/x_thumb.gif',
        '衰' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/af/cry.gif',
        '委屈' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/73/wq_thumb.gif',
        '吐' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/9e/t_thumb.gif',
        '哈欠' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/cc/haqianv2_thumb.gif',
        '抱抱' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/27/bba_thumb.gif',
        '怒' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/7c/angrya_thumb.gif',
        '疑问' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/5c/yw_thumb.gif',
        '馋嘴' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/a5/cza_thumb.gif',
        '拜拜' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/70/88_thumb.gif',
        '思考' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/e9/sk_thumb.gif',
        '汗' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/24/sweata_thumb.gif',
        '困' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/40/kunv2_thumb.gif',
        '睡' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/96/huangliansj_thumb.gif',
        '钱' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/90/money_thumb.gif',
        '失望' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/0c/sw_thumb.gif',
        '酷' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/40/cool_thumb.gif',
        '色' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/20/huanglianse_thumb.gif',
        '哼' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/49/hatea_thumb.gif',
        '鼓掌' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/36/gza_thumb.gif',
        '晕' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/d9/dizzya_thumb.gif',
        '悲伤' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/1a/bs_thumb.gif',
        '抓狂' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/62/crazya_thumb.gif',
        '黑线' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/91/h_thumb.gif',
        '阴险' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/6d/yx_thumb.gif',
        '怒骂' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/60/numav2_thumb.gif',
        '互粉' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/89/hufen_thumb.gif',
        '心' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/40/hearta_thumb.gif',
        '伤心' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/ea/unheart.gif',
        '猪头' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/58/pig.gif',
        '熊猫' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/6e/panda_thumb.gif',
        '兔子' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/81/rabbit_thumb.gif',
        'ok' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/d6/ok_thumb.gif',
        '耶' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/d9/ye_thumb.gif',
        'good' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/d8/good_thumb.gif',
        'NO' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/ae/buyao_org.gif',
        '赞' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/d0/z2_thumb.gif',
        '来' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/40/come_thumb.gif',
        '弱' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/d8/sad_thumb.gif',
        '草泥马' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/7a/shenshou_thumb.gif',
        '神马' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/60/horse2_thumb.gif',
        '囧' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/15/j_thumb.gif',
        '浮云' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/bc/fuyun_thumb.gif',
        '给力' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/1e/geiliv2_thumb.gif',
        '围观' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/f2/wg_thumb.gif',
        '威武' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/70/vw_thumb.gif',
        '奥特曼' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/bc/otm_thumb.gif',
        '礼物' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/c4/liwu_thumb.gif',
        '钟' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/d3/clock_thumb.gif',
        '话筒' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/9f/huatongv2_thumb.gif',
        '蜡烛' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/d9/lazhuv2_thumb.gif',
        '蛋糕' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/3a/cakev2_thumb.gif',
        'doge' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/b6/doge_thumb.gif',
        '喵喵' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/4a/mm_thumb.gif',
        '二哈' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/74/moren_hashiqi_thumb.png',
        '笑cry' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/34/xiaoku_thumb.gif',
        '摊手' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/09/pcmoren_tanshou_thumb.png',
        '抱抱' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/70/pcmoren_baobao_thumb.png',
        '坏笑' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/50/pcmoren_huaixiao_thumb.png',
        '污' : 'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/3c/pcmoren_wu_thumb.png',
    };
    for (var _k in face_arr) {
        var face_url = face_arr[_k];
        var face_html = '<img class="face" src="' + face_url + '" title="' + _k + '">';
        str = str.replace(new RegExp('\\[' + _k + '\\]', 'gmi'), face_html);
    }
    return str;
}

//换行符转化为<br>
function html_newline(str){
    return str.replace(/\n/g, '<br>');
}

//字符串验证
var simple_validate = {
    //验证是否为空字符串
    required : function(str){
        str = str.trim();
        if(str == ''){
            return false;
        }
        return true;
    },

    //验证邮箱
    email : function(str){
        var reg = /^(\w-*\.*)+@(\w-?)+(\.\w{2,})+$/;
        return reg.test(str);
    },

    //验证昵称
    nickname : function(str){
        var reg = /^[\u4e00-\u9fa5a-zA-Z0-9-]{1,16}$/;
        return reg.test(str);
    },

    //验证手机号
    mobile : function(str){
        var reg = /^1[34578]\d{9}$/;
        return reg.test(str);
    },

    //验证QQ号
    qq : function(str){
        var reg = /[1-9][0-9]{4,10}/;
        return reg.test(str);
    },

    //验证域名
    domain : function(str){
        var reg = /[a-zA-Z0-9][-a-zA-Z0-9]{0,62}(\.[a-zA-Z0-9][-a-zA-Z0-9]{0,62})+\.?/;
        return reg.test(str);
    },

    //长度范围
    range : function(str, min, max){
        if(str.length >= min && str.length < max){
            return true;
        }
        return false;
    },

    //长度范围(中英文混合)
    mix_range : function(str, min, max){
        var len = 0;
        for (var i = 0; i < str.length; i++) {
            var c = str.charCodeAt(i);
            //单字节加1,双字节加2
            if ((c >= 0x0001 && c <= 0x007e) || (0xff60 <= c && c <= 0xff9f)) {
                len++;
            }
            else {
                len += 2;
            }
        }
        if(len >= min && len <= max){
            return true;
        }
        return false;
    },

    //验证0或大于0的整数
    number : function(str){
        var reg = /^(0|[1-9][0-9]*)$/;
        return reg.test(str);
    }
};

/*生成新dom闪烁的通知(背景闪烁效果)*/
function create_dom_notice($element){
    var i = 0;
    var notice = setInterval(function(){
        $element.toggleClass('create_dom_notice');
        if (i++ > 6) {
            clearInterval(notice);
        }
    }, 300);
}

//错误信息
var __errors__ = {
                '0' : '查无结果',
                '-100001' : '缺少参数',
                '-200001' : '完善资料失败，请先使用第三方社交账号登录',
                '-200002' : '完善资料失败，请填写昵称',
                '-200003' : '完善资料失败，昵称长度应为1-16位，1个中文算2个字符长度',
                '-200004' : '完善资料失败，此昵称已被占用，请更换',
                '-200005' : '此操作需要登录',
                '-200006' : '发布文章失败',
                '-200007' : '文章不存在',
                '-200008' : '个人资料更新失败',
                '-200009' : '个人资料更新失败，个人简介最大长度为140，1个中文算2个字符长度',
                '-200010' : '发布文章失败，请填写标题',
                '-200011' : '发布文章失败，标题长度应为10-100字符，1个中文算2个字符长度',
                '-200012' : '发布文章失败，请填写文章内容',
                '-200013' : '发布文章失败，文章内容长度应为10-10000字符，1个中文算2个字符长度',
                '-200014' : '回复失败，请填写回复内容',
                '-200015' : '回复失败，回复内容长度应为10-10000字符，1个中文算2个字符长度',
                '-200016' : '给文章投票失败，您已投票过啦',
                '-200017' : '给文章的评论投票失败，您已投票过啦',
                '-200018' : '此操作需要管理员账号登录',
                '-200019' : '回复失败，对话不存在',
                '-200020' : '回复失败，文章不存在',
                '-200021' : '回复失败，原评论不存在',
                '-200022' : '消息删除失败，消息不存在',
                '-200023' : '消息删除失败，你不是你的消息',
                '-200024' : '回复失败',
                '-200025' : '站长认证失败，请填写网站域名',
                '-200026' : '站长认证失败，网站域名格式错误，示例：qq.com或weixin.qq.com',
                '-200027' : '站长认证失败，请确保已经下载验证文件放到网站根目录',
                '-200028' : '微博认证失败，请先绑定微博账号',
                '-200029' : '微博认证失败，获取微博信息失败，一般是因为微博授权过期了，请退出账号重新使用微博账号登录试一下',
                '-200030' : '微博认证失败，您绑定的微博账号貌似还未通过微博认证',
                '-200031' : '文章追加失败，只能追加自己的文章',
                '-200032' : '今天已经签到过啦，请明天再来吧',

                '-200148' : '验证码错误(Geetest)，请刷新验证码重试',
                '-200149' : '验证码错误，请刷新验证码重试',

                '-200151' : '账号登录失败(账号或密码错误)',
                '-200152' : '账号登录失败(异常)',
                '-200154' : '账号注册失败(邮箱已被注册)',
                '-200155' : '账号注册失败(异常)',

                '-200064' : '皮肤背景图片锁定失败，请先设置皮肤',

                '-200071' : '解除绑定关联账号失败',
                '-200072' : '绑定邮箱失败，邮箱格式错误',
                '-200073' : '绑定邮箱失败，此账号已绑定了邮箱',
                '-200074' : '绑定邮箱失败，此邮箱已被其它账号绑定',
                '-200075' : '重发验证邮箱失败，此账号还未绑定邮箱',
                '-200076' : '重发验证邮箱失败，此账号邮箱已激活',
                '-200077' : '绑定邮箱失败，密码长度应为6-16位',

                '-200183' : '解绑失败，请先绑定邮箱',

                '-200192' : '登录失败，邮箱不能为空',
                '-200193' : '登录失败，邮箱长度不能超过30个字符',
                '-200194' : '登录失败，邮箱格式错误',
                '-200195' : '登录失败，密码不能为空',
                '-200196' : '登录失败，密码长度为6-16个字符',
                '-200197' : '注册失败，邮箱不能为空',
                '-200198' : '注册失败，邮箱长度不能超过30个字符',
                '-200199' : '注册失败，邮箱格式错误',
                '-200200' : '注册失败，密码不能为空',
                '-200201' : '注册失败，密码长度为6-16个字符',
                '-200202' : '注册失败，昵称不能为空',
                '-200203' : '注册失败，昵称长度为1-16位，1个中文算2个字符',
                '-200204' : '注册失败，昵称只能为中文、字母、数字或横线-',
                '-200205' : '绑定已有账号失败，请先使用社交账号登录',
                '-200206' : '绑定已有账号失败，邮箱不能为空',
                '-200207' : '绑定已有账号失败，邮箱长度不能超过30个字符',
                '-200208' : '绑定已有账号失败，邮箱格式错误',
                '-200209' : '绑定已有账号失败，密码不能为空',
                '-200210' : '绑定已有账号失败，密码长度为6-16个字符',
                '-200211' : '绑定已有账号失败，账号或密码错误',
                '-200212' : '绑定已有账号失败，此社交账号已被其它邮箱账号绑定了',
                '-200213' : '绑定已有账号失败，此邮箱账号已绑定了此类社交账号，不可重复绑定',
                '-200214' : '重置密码失败，原密码长度为6-16个字符',
                '-200215' : '重置密码失败，新密码长度为6-16个字符',
                '-200216' : '重置密码失败，原密码错误',
                '-200217' : '采纳答案失败，只能操作自己的提问',
                '-200218' : '完善资料失败，昵称只能为中文、字母、数字或横线-',

                '-200301' : '冒泡：发布失败',
                '-200302' : '冒泡：发布失败，请填写冒泡内容',
                '-200303' : '冒泡：发布失败，冒泡内容长度应为10-140字符，1个中文算2个字符长度',
                '-200304' : '冒泡：回复失败，请填写回复内容',
                '-200305' : '冒泡：回复失败，回复内容长度应为10-140字符，1个中文算2个字符长度',
                '-200306' : '冒泡：回复失败，冒泡不存在',
                '-200307' : '冒泡：回复失败，原评论不存在',
                '-200308' : '冒泡：回复失败，对话不存在',
                '-200309' : '冒泡：回复失败',
                '-200310' : '冒泡：投票失败，您已投票过啦',
                '-200311' : '冒泡：评论投票失败，您已投票过啦'
             };

//显示错误信息
function show_error(error_code){
    layer.alert(__errors__[error_code], {icon:5, shade:0, title:'错误代码：' + error_code});
}

/*******************************************我是华丽的分割线****************************************************/

//格式化日期成 yyyy-mm-dd
function dateFormat(date){
	var year = date.getFullYear();
	var month = date.getMonth() + 1;
	var day = date.getDate();
	if(month < 10){
		month = '0' + month;
	}
	if(day < 10){
		day = '0' + day;
	}
	return year + '-' + month + '-' + day;
}

//格式化时间成 hh:mm:dd
function timeFormat(date){
	var hours = date.getHours();
	var minutes = date.getMinutes();
	var seconds = date.getSeconds();
	if(hours < 10){
		hours = '0' + hours;
	}
	if(minutes < 10){
		minutes = '0' + minutes;
	}
	if(seconds < 10){
		seconds = '0' + seconds;
	}
	return hours + ':' + minutes + ':' + seconds;
}

//格式化日期时间成 yyyy-mm-dd hh:mm:dd
function datetimeFormat(date){
	return dateFormat(date) + ' ' + timeFormat(date);
}

/*******************************************我是华丽的分割线****************************************************/

//中英文混合字符串长度
function mix_strlen(str){
    var len = 0;
    for (var i = 0; i < str.length; i++) {
        var c = str.charCodeAt(i);
        //单字节加1,双字节加2
        if ((c >= 0x0001 && c <= 0x007e) || (0xff60 <= c && c <= 0xff9f)) {
            len++;
        }
        else {
            len += 2;
        }
    }
    return len;
}

/*******************************************我是华丽的分割线****************************************************/

//创建dom element,暂时只支持创建js和css
function create_element(type, url){
    var head = document.head || document.getElementsByTagName('head')[0];
    var element = '';
    if(type == 'js'){
        element = document.createElement('script');
        element.type = 'text/javascript';
        element.src = url;
    }
    else if(type == 'css'){
        var element = document.createElement('link');
        element.href = url;
        element.rel = 'stylesheet';
        element.type = 'text/css';
    }
    head.appendChild(element);
}

/*******************************************我是华丽的分割线****************************************************/

//生成用户头像url
function create_avatar_url(user_id, avatar_ext){
	var avatar_url = CONFIG['avatar_base_url'];
    if (avatar_ext != null && avatar_ext != '') {
        //如果不存在问号字符,则为系统提供的头像
        if (avatar_ext.indexOf('?') >= 0) {
            var arr = avatar_ext.split('?');
            avatar_url += user_id + '.' + arr[0] + '!avatar?' + arr[1];
        } else {
            avatar_url += 's/' + avatar_ext + '!avatar';
        }
    } else {
        avatar_url += '0.png!avatar';
    }
    return avatar_url;
}

/*******************************************我是华丽的分割线****************************************************/

//获取文件扩展名
function get_ext_with_type(type){
    var ext = '';
    if(type == 'image/jpeg' || type == 'image/pjpeg'){
        ext = 'jpg';
    }
    else if(type == 'image/png'){
        ext = 'png';
    }
    else if(type == 'image/gif'){
        ext = 'gif';
    }
    return ext;
}

/*******************************************我是华丽的分割线****************************************************/

//富文本编辑相关

//创建富文本编辑器
function create_rich_editor(element_id, rich_content, placeholder, height, is_focus){
    var num = new Date().getTime();
    var rich_editor_id = 'rich_editor_' + num;
    var select_img_btn_id = 'select_img_btn_' + num;
    var rich_content_id = 'rich_content_' + num;
    var html = '<div id="' + rich_editor_id + '" num="' + num + '" class="layui-form-item layui-form-text rich_editor">'
                    +'<div class="edit_toolbar">'
                        +'<a class="face_box_show_btn pr" href="javascript:;" onclick="face_box_show(this);"><i class="iconfont">&#xe600;</i>表情'
                            +'<div class="layui-layer layui-layer-tips layui-edit-face layer-anim toolbox face_box"></div>'
                        +'</a>'
                        +'<a class="yan_face_box_show_btn pr" href="javascript:;" onclick="yan_face_box_show(this);">(°∀°)ﾉ'
                            +'<div class="layui-layer layui-layer-tips layui-edit-face layer-anim toolbox yan_face_box"></div>'
                        +'</a>'
                        +'<a href="javascript:;" onclick="insert_code_show(this);"><i class="iconfont">&#xe6f3;</i>代码</a>'
                        +'<a id="' + select_img_btn_id + '" href="javascript:;"><i class="iconfont">&#xe60b;</i>图片</a>'
                    +'</div>'
                    +'<div class="layui-input-block">'
                        +'<textarea id="' + rich_content_id + '" name="rich_content" placeholder="' + placeholder + '" class="layui-textarea" style="height: ' + height + 'px;">' + rich_content + '</textarea>'
                    +'</div>'
                +'</div>';
    $('#' + element_id).html(html);
    if(is_focus){
        $('#rich_content_' + num).focus();
    }
    rich_editor_select_img_bind(num);
    return num;
}

//输入框光标处插入内容
function cursor_insert(element_id, str){
    var t = document.getElementById(element_id);
    if (typeof t.selectionStart === 'number' && typeof t.selectionEnd === 'number') {
        var startPos = t.selectionStart,
            endPos = t.selectionEnd,
            cursorPos = startPos,
            tmpStr = t.value;
        t.value = tmpStr.substring(0, startPos) + str + tmpStr.substring(endPos, tmpStr.length);
        cursorPos += str.length;
        t.selectionStart = t.selectionEnd = cursorPos;
    } else {
        t.value += str;
    }
    $('#' + element_id).focus();
}

//显示插入代码弹出层
function insert_code_show(This){
    var $this = $(This);
    var num = $this.parents('.rich_editor').attr('num');
    $('.edit_toolbar .layui-layer').hide();
    if($('#code_content').length > 0){
        $('#code_content').parents('.layui-layer').remove();
        return;
    }
    var html = '<div style="margin:15px;">'
                    +'<textarea id="code_content" class="layui-textarea" style="width:730px; height:370px;" placeholder="请输入程序代码"></textarea>'
                    +'<button class="layui-btn mt15 fr" onclick="insert_code(' + num + ');">确定</button>'
                +'</div>';
    layer.open({
        type: 1,
        title: '添加代码，显示时会自动格式化',
        shadeClose: true,
        shift:5,
        shade: false,
        area: ['760px', '500px'],
        maxmin: true,
        content: html,
        success: function(){
            $('#code_content').focus();
        }
    });
}

//插入代码
function insert_code(num){
    var str = $('#code_content').val().trim();
    if(str == ''){
        layer.msg('请填写代码...');
        $('#code_content').focus();
        return;
    }
    str = '[code]' + str + '[/code]';
    cursor_insert('rich_content_' + num, str);
    $('#code_content').parents('.layui-layer').remove();
}

//显示表情弹出层
function face_box_show(This){
    var $this = $(This);
    var num = $this.parents('.rich_editor').attr('num');
    //layer.closeAll();
    if($('.face_box').is(':visible')){
        $('.face_box').hide();
        return;
    }
    $('.edit_toolbar .layui-layer').hide();
    var html = '<ul class="layui-clear">'
                    +'<li title="[微笑]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/5c/huanglianwx_thumb.gif"></li>'
                    +'<li title="[嘻嘻]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/0b/tootha_thumb.gif"></li>'
                    +'<li title="[哈哈]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/6a/laugh.gif"></li>'
                    +'<li title="[可爱]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/14/tza_thumb.gif"></li>'
                    +'<li title="[可怜]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/af/kl_thumb.gif"></li>'
                    +'<li title="[挖鼻]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/0b/wabi_thumb.gif"></li>'
                    +'<li title="[吃惊]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/f4/cj_thumb.gif"></li>'
                    +'<li title="[害羞]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/6e/shamea_thumb.gif"></li>'
                    +'<li title="[挤眼]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/c3/zy_thumb.gif"></li>'
                    +'<li title="[闭嘴]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/29/bz_thumb.gif"></li>'
                    +'<li title="[鄙视]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/71/bs2_thumb.gif"></li>'
                    +'<li title="[爱你]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/6d/lovea_thumb.gif"></li>'
                    +'<li title="[泪]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/9d/sada_thumb.gif"></li>'
                    +'<li title="[偷笑]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/19/heia_thumb.gif"></li>'
                    +'<li title="[亲亲]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/8f/qq_thumb.gif"></li>'
                    +'<li title="[生病]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/b6/sb_thumb.gif"></li>'
                    +'<li title="[太开心]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/58/mb_thumb.gif"></li>'
                    +'<li title="[白眼]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/d9/landeln_thumb.gif"></li>'
                    +'<li title="[右哼哼]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/98/yhh_thumb.gif"></li>'
                    +'<li title="[左哼哼]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/6d/zhh_thumb.gif"></li>'
                    +'<li title="[嘘]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/a6/x_thumb.gif"></li>'
                    +'<li title="[衰]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/af/cry.gif"></li>'
                    +'<li title="[委屈]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/73/wq_thumb.gif"></li>'
                    +'<li title="[吐]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/9e/t_thumb.gif"></li>'
                    +'<li title="[哈欠]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/cc/haqianv2_thumb.gif"></li>'
                    +'<li title="[抱抱]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/27/bba_thumb.gif"></li>'
                    +'<li title="[怒]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/7c/angrya_thumb.gif"></li>'
                    +'<li title="[疑问]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/5c/yw_thumb.gif"></li>'
                    +'<li title="[馋嘴]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/a5/cza_thumb.gif"></li>'
                    +'<li title="[拜拜]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/70/88_thumb.gif"></li>'
                    +'<li title="[思考]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/e9/sk_thumb.gif"></li>'
                    +'<li title="[汗]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/24/sweata_thumb.gif"></li>'
                    +'<li title="[困]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/40/kunv2_thumb.gif"></li>'
                    +'<li title="[睡]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/96/huangliansj_thumb.gif"></li>'
                    +'<li title="[钱]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/90/money_thumb.gif"></li>'
                    +'<li title="[失望]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/0c/sw_thumb.gif"></li>'
                    +'<li title="[酷]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/40/cool_thumb.gif"></li>'
                    +'<li title="[色]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/20/huanglianse_thumb.gif"></li>'
                    +'<li title="[哼]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/49/hatea_thumb.gif"></li>'
                    +'<li title="[鼓掌]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/36/gza_thumb.gif"></li>'
                    +'<li title="[晕]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/d9/dizzya_thumb.gif"></li>'
                    +'<li title="[悲伤]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/1a/bs_thumb.gif"></li>'
                    +'<li title="[抓狂]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/62/crazya_thumb.gif"></li>'
                    +'<li title="[黑线]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/91/h_thumb.gif"></li>'
                    +'<li title="[阴险]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/6d/yx_thumb.gif"></li>'
                    +'<li title="[怒骂]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/60/numav2_thumb.gif"></li>'
                    +'<li title="[互粉]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/89/hufen_thumb.gif"></li>'
                    +'<li title="[心]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/40/hearta_thumb.gif"></li>'
                    +'<li title="[伤心]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/ea/unheart.gif"></li>'
                    +'<li title="[猪头]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/58/pig.gif"></li>'
                    +'<li title="[熊猫]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/6e/panda_thumb.gif"></li>'
                    +'<li title="[兔子]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/81/rabbit_thumb.gif"></li>'
                    +'<li title="[ok]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/d6/ok_thumb.gif"></li>'
                    +'<li title="[耶]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/d9/ye_thumb.gif"></li>'
                    +'<li title="[good]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/d8/good_thumb.gif"></li>'
                    +'<li title="[NO]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/ae/buyao_org.gif"></li>'
                    +'<li title="[赞]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/d0/z2_thumb.gif"></li>'
                    +'<li title="[来]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/40/come_thumb.gif"></li>'
                    +'<li title="[弱]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/d8/sad_thumb.gif"></li>'
                    +'<li title="[草泥马]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/7a/shenshou_thumb.gif"></li>'
                    +'<li title="[神马]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/60/horse2_thumb.gif"></li>'
                    +'<li title="[囧]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/15/j_thumb.gif"></li>'
                    +'<li title="[浮云]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/bc/fuyun_thumb.gif"></li>'
                    +'<li title="[给力]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/1e/geiliv2_thumb.gif"></li>'
                    +'<li title="[围观]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/f2/wg_thumb.gif"></li>'
                    +'<li title="[威武]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/70/vw_thumb.gif"></li>'
                    +'<li title="[奥特曼]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/bc/otm_thumb.gif"></li>'
                    +'<li title="[礼物]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/c4/liwu_thumb.gif"></li>'
                    +'<li title="[钟]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/d3/clock_thumb.gif"></li>'
                    +'<li title="[话筒]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/9f/huatongv2_thumb.gif"></li>'
                    +'<li title="[蜡烛]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/d9/lazhuv2_thumb.gif"></li>'
                    +'<li title="[蛋糕]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/3a/cakev2_thumb.gif"></li>'
                    +'<li title="[doge]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/b6/doge_thumb.gif"></li>'
                    +'<li title="[喵喵]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/4a/mm_thumb.gif"></li>'
                    +'<li title="[二哈]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/74/moren_hashiqi_thumb.png"></li>'
                    +'<li title="[笑cry]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/34/xiaoku_thumb.gif"></li>'
                    +'<li title="[摊手]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/09/pcmoren_tanshou_thumb.png"></li>'
                    +'<li title="[抱抱]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/70/pcmoren_baobao_thumb.png"></li>'
                    +'<li title="[坏笑]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/50/pcmoren_huaixiao_thumb.png"></li>'
                    +'<li title="[污]"><img src="http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/3c/pcmoren_wu_thumb.png"></li>'
                +'</ul>';
    $('>.layui-edit-face', $this).html(html).show();
    $('#rich_content_' + num).focus();
}

//显示颜表情弹出层
function yan_face_box_show(This){
    var $this = $(This);
    var num = $this.parents('.rich_editor').attr('num');
    //layer.closeAll();
    if($('.yan_face_box').is(':visible')){
        $('.yan_face_box').hide();
        return;
    }
    $('.edit_toolbar .layui-layer').hide();
    var html = '<ul class="layui-clear">'
                +'<li>(⌒▽⌒)</li>'
                +'<li>（￣▽￣）</li>'
                +'<li>(=・ω・=)</li>'
                +'<li>(｀・ω・´)</li>'
                +'<li>(〜￣△￣)〜</li>'
                +'<li>(･∀･)</li>'
                +'<li>(°∀°)ﾉ</li>'
                +'<li>(￣3￣)</li>'
                +'<li>╮(￣▽￣)╭</li>'
                +'<li>( ´_ゝ｀)</li>'
                +'<li>←_←</li>'
                +'<li>→_→</li>'
                +'<li>(<_<)</li>'
                +'<li>(>_>)</li>'
                +'<li>(;¬_¬)</li>'
                +'<li>("▔□▔)/</li>'
                +'<li>(ﾟДﾟ≡ﾟдﾟ)!?</li>'
                +'<li>Σ(ﾟдﾟ;)</li>'
                +'<li>Σ( ￣□￣||)</li>'
                +'<li>(´；ω；`)</li>'
                +'<li>（/TДT)/</li>'
                +'<li>(^・ω・^ )</li>'
                +'<li>(｡･ω･｡)</li>'
                +'<li>(●￣(ｴ)￣●)</li>'
                +'<li>(´･_･`)</li>'
                +'<li>(-_-#)</li>'
                +'<li>（￣へ￣）</li>'
                +'<li>(￣ε(#￣) Σ</li>'
                +'<li class="big_face">ε=ε=(ノ≧∇≦)ノ</li>'
                +'<li>ヽ(`Д´)ﾉ</li>'
                +'<li>_(:3」∠)_</li>'
                +'<li>(笑)</li>'
                +'<li class="big_face">(╯°口°)╯(┴—┴</li>'
                +'<li>(汗)</li>'
                +'<li>(泣)</li>'
                +'<li>(苦笑)</li>'
                +'<li class="big_face">（#-_-)┯━┯</li>'
            +'</ul>';
    $('>.layui-edit-face', $this).html(html).show();
    $('#rich_content_' + num).focus();
}

//绑定富文本编辑器的上传图片按钮事件
function rich_editor_select_img_bind(num){
    var current_uploader_key = '';
    //反馈图片上传
    var uploader = Qiniu.uploader({
        runtimes: 'html5,flash,html4',    // 上传模式，依次退化
        browse_button: 'select_img_btn_' + num,    // 上传选择的点选按钮，必需
        // 在初始化时，uptoken，uptoken_url，uptoken_func三个参数中必须有一个被设置
        // 切如果提供了多个，其优先级为uptoken > uptoken_url > uptoken_func
        // 其中uptoken是直接提供上传凭证，uptoken_url是提供了获取上传凭证的地址，如果需要定制获取uptoken的过程则可以设置uptoken_func
        // uptoken : '<Your upload token>', // uptoken是上传凭证，由其他程序生成
        uptoken_url: '/baseapi/qiniu/uptoken?bucket=' + CONFIG['qiniu']['static_bucket_name'],     // Ajax请求uptoken的Url，强烈建议设置（服务端提供）
        // uptoken_func: function(file){  // 在需要获取uptoken时，该方法会被调用
        //  // do something
        //  return uptoken;
        // },
        get_new_uptoken: true,      // 设置上传文件的时候是否每次都重新获取新的uptoken
        //downtoken_url: '',
        // Ajax请求downToken的Url，私有空间时使用，JS-SDK将向该地址POST文件的key和domain，服务端返回的JSON必须包含url字段，url值为该文件的下载地址
        // unique_names: true,        // 默认false，key为文件名。若开启该选项，JS-SDK会为每个文件自动生成key（文件名）
        // save_key: true,          // 默认false。若在服务端生成uptoken的上传策略中指定了sava_key，则开启，SDK在前端将不对key进行任何处理
        domain: 'http://' + CONFIG['qiniu']['static_bucket_domain'] + '/',   // bucket域名，下载资源时用到，必需
        //container: 'upload_container',      // 上传区域DOM ID，默认是browser_button的父元素
        max_file_size: '100mb',      // 最大文件体积限制
        flash_swf_url: '/static/lib/plupload/Moxie.swf',  //引入flash，相对路径
        max_retries: 3,          // 上传失败最大重试次数
        dragdrop: false,          // 开启可拖曳上传
        //drop_element: 'upload_container',      // 拖曳上传区域元素的ID，拖曳文件或文件夹后可触发上传
        chunk_size: '4mb',          // 分块上传时，每块的体积
        auto_start: true,          // 选择文件后自动上传，若关闭需要自己绑定事件触发上传
        filters: {
            mime_types : [ //只允许上传图片和zip文件
                { title : 'Image files', extensions : 'jpg,jpeg,png,gif' }
            ],
            max_file_size : '1024kb', //最大只能上传400kb的文件
            prevent_duplicates : true //不允许选取重复文件
        },
        multi_selection: false,
        init: {
            'FilesAdded': function(up, files) {
                var ext = get_ext_with_type(files[0].type);
                var now = new Date();
                var key = 'attachment/';
                key += now.getTime();
                key += '.' + ext;
                current_uploader_key = key;
                Qiniu.uptoken_url = '/baseapi/qiniu/uptoken?bucket=' + CONFIG['qiniu']['static_bucket_name'] + '&type=attachment&key=' + current_uploader_key;
            },
            'BeforeUpload': function(up, file) {
                // 每个文件上传前，处理相关的事情
                layer.load();
            },
            'UploadProgress': function(up, file) {
                // 每个文件上传时，处理相关的事情
            },
            'FileUploaded': function(up, file, info) {
                // 每个文件上传成功后，处理相关的事情
                // 其中info是文件上传成功后，服务端返回的json，形式如：
                // {
                //  "hash": "Fh8xVqod2MQ1mocfI4S4KpRL6D98",
                //  "key": "gogopher.jpg"
                //  }
                // 查看简单反馈
                var domain = up.getOption('domain');
                var res = $.parseJSON(info);
                res.url = domain + res.key;
                //插入图片
                var insert_content = '[img]' + res.key + '[/img]';
                cursor_insert('rich_content_' + num, insert_content);
                layer.msg('图片上传成功。');
            },
            'Error': function(up, err, errTip) {
                //上传出错时，处理相关的事情
                //文件类型不对
                if(err.code == plupload.FILE_EXTENSION_ERROR){
                    layer.msg('文件类型错误。');
                }
                //文件大小超过限制
                else if(err.code == plupload.FILE_SIZE_ERROR){
                    layer.msg('文件尺寸超过限制。');
                }
            },
            'UploadComplete': function(up, files, info) {
                //队列文件处理完毕后，处理相关的事情
                layer.closeAll('loading');
            },
            'Key': function(up, file) {
                // 若想在前端对每个文件的key进行个性化处理，可以配置该函数
                // 该配置必须要在unique_names: false，save_key: false时才生效
                // do something with key here
                return current_uploader_key;
            }
        }
    });
}

//控制显示/隐藏表情弹出层
$(function(){
    $(document).on('click', '.face_box>ul>li', function(event){
        var num = $(this).parents('.rich_editor').attr('num');
        var str = $(this).attr('title');
        cursor_insert('rich_content_' + num, str);
        $('.face_box').hide();
        event.stopPropagation();
        event.preventDefault();
    });

    $(document).on('click', '.face_box_show_btn', function(event){
        event.stopPropagation();
        event.preventDefault();
    });
});

//控制显示/隐藏表情弹出层
$(function(){
    $(document).on('click', '.yan_face_box>ul>li', function(event){
        var num = $(this).parents('.rich_editor').attr('num');
        var str = $(this).html();
        cursor_insert('rich_content_' + num, str);
        $('.yan_face_box').hide();
        event.stopPropagation();
        event.preventDefault();
    });

    $(document).on('click', '.yan_face_box_show_btn', function(event){
        event.stopPropagation();
        event.preventDefault();
    });
});

//控制点击页面隐藏表情/颜表情弹出框
$(function(){
    $(document).click(function(){
        if($('.face_box:visible, .yan_face_box:visible').length > 0){
            //$('.face_box, .yan_face_box').hide();
        }
    });
});

/*******************************************我是华丽的分割线****************************************************/

$(function(){
    if(typeof layui != 'undefined'){
        layui.use('form', function(){
            var form = layui.form();
        });

        var util = layui.util;
        util.fixbar({
            bgcolor: '#009E94'
        });
    }
});

/*******************************************我是华丽的分割线****************************************************/

//发布/更新文章页面

//发布文章
function article_add(This){
    var $this = $(This);
    var num = $('.rich_editor', $this).attr('num');
    var $article_type = $('#article_type');
    var article_type = $article_type.val();
    var $article_title = $('#article_title');
    var article_title = $article_title.val();
    var $rich_content = $('#rich_content_' + num);
    var rich_content = $rich_content.val();
    var $article_topics = $('#article_topics');
    var article_topics = $article_topics.val();

    //检查标签
    if(article_topics != ''){
        var topics_arr = article_topics.split(/[\s,]+/);
        var counts = topics_arr.length;
        if(counts > 5){
            layer.msg('标签最多可设置5个');
            return false;
        }
        for(i = 0; i < counts; i++){
            //验证长度(中英文混合字符长度)
            var length = mix_strlen(topics_arr[i]);
            if(length > 20){
                layer.msg('标签"' + topics_arr[i] + '"太长啦，每个标签最大长度为20，1个中文算2个字符');
                return false;
            }
        }
    }

    if(!simple_validate.required(article_title)){
        layer.msg('请填写标题');
        $article_title.focus();
        return false;
    }

    if(!simple_validate.mix_range(article_title, 10, 100)){
        layer.msg('标题长度应为10-100位，1个中文算是2个字符长度');
        $article_title.focus();
        return false;
    }

    if(!simple_validate.required(rich_content)){
        layer.msg('请填写内容');
        $rich_content.focus();
        return false;
    }

    if(!simple_validate.mix_range(rich_content, 10, 10000)){
        layer.msg('内容长度应为10-10000位，1个中文算是2个字符长度');
        $rich_content.focus();
        return false;
    }

    if(article_type == ''){
        layer.msg('请选择文章分类');
        return false;
    }

    layer.load();
    $.post(
        '/api/article/add',
        {
            article_type: article_type,
            article_title: article_title,
            article_content: rich_content,
            article_topics: article_topics
        },
        function(json){
            if(json.error_code == 'ok'){
                document.location = '/' + CONFIG['enum_show']['article_type'][article_type] + '/detail/' + json.article.id;
            }
            else{
                layer.closeAll('loading');
                show_error(json.error_code);
            }
        },
        'json'
    );
    return false;
}

//追加文章
function article_append(This){
    var $this = $(This);
    var num = $('.rich_editor', $this).attr('num');
    var $rich_content = $('#rich_content_' + num);
    var rich_content = $rich_content.val();

    if(!simple_validate.required(rich_content)){
        layer.msg('请填写内容');
        $rich_content.focus();
        return false;
    }

    if(!simple_validate.mix_range(rich_content, 10, 10000)){
        layer.msg('内容长度应为10-10000位，1个中文算是2个字符长度');
        $rich_content.focus();
        return false;
    }

    $.post(
        '/api/article/append',
        {
            article_id: article_id,
            append_content: rich_content
        },
        function(json){
            if(json.error_code == 'ok'){
                document.location = '/' + CONFIG['enum_show']['article_type'][article_type] + '/detail/' + article_id;
            }
            else{
                show_error(json.error_code);
            }
        },
        'json'
    );
    return false;
}

/*******************************************我是华丽的分割线****************************************************/

//文章详情页面

//显示回复评论框
function comment_reply_show(This){
    //注意这个num是包围编辑器的num，并不是编辑器的num
    var num = new Date().getTime();
    var $this = $(This);
    var comment_id = $this.attr('comment_id');
    var dialog_id = $this.attr('dialog_id');
    var nickname = $this.attr('nickname');

    var $reply = $this.parent('div').children('.reply');
    if($reply.length == 0){
        var rich_editor_wrapper_id = 'rich_editor_wrapper_' + num;
        var html = '<div class="layui-form layui-form-pane reply mt10 none">'
                        +'<form method="post" comment_id="' + comment_id + '" dialog_id="' + dialog_id + '" onsubmit="return comment_add(this);">'
                            +'<div id="rich_editor_wrapper_' + num + '" num="' + num + '"></div>'
                            +'<div class="layui-form-item tr">'
                                +'<button type="submit" class="layui-btn layui-btn-small layui-btn-danger"><i class="iconfont">&#xe619;</i> 回复</button>'
                            +'</div>'
                        +'</form>'
                    +'</div>';
        $this.parent('div').append(html);
        var num = create_rich_editor(rich_editor_wrapper_id, '', '请输入回复内容', '80', false);
        $reply = $this.parent('div').children('.reply');
        $reply.stop(true, true).slideDown(300, function(){
            $('#rich_content_' + num).val('').val('回复@' + nickname + ':').focus();
        });
    }
    else{
        if($reply.is(':visible')){
            $reply.stop(true, true).slideUp(300);
        }
        else{
            $reply.stop(true, true).slideDown(300, function(){
                $(' textarea', $reply).focus();
            });
        }
    }
}

//提交文章评论
function comment_add(This){
    var $this = $(This);
    var $comment_content = $(' textarea', $this);
    var comment_content = $comment_content.val();
    var comment_id = $this.attr('comment_id');
    var dialog_id = $this.attr('dialog_id');

    if(!simple_validate.required(comment_content)){
        layer.msg('请填写回复内容');
        $comment_content.focus();
        return false;
    }

    if(!simple_validate.mix_range(comment_content, 10, 10000)){
        layer.msg('回复内容长度应为10-10000位，1个中文算是2个字符长度');
        $comment_content.focus();
        return false;
    }

    $.post(
        '/api/comment/add',
        {
            article_id: article_id,
            comment_content: comment_content,
            comment_id: comment_id,
            dialog_id: dialog_id
        },
        function(json){
            if(json.error_code == 'ok'){
                var html = create_comment_html(json.comment);
                $('.jieda>.fly-none').remove();
                $('.jieda').append(html);
                create_dom_notice($('.jieda>li:last'));

                //隐藏回复框
                $comment_content.val('');
                var $jieda_reply = $this.parents('.jieda-reply');
                $jieda_reply.children('.reply').remove();

                layer.msg('回复成功');
            }
            else{
                show_error(json.error_code);
            }
        },
        'json'
    );
    return false;
}

//显示对话弹出层
function dialog_show(This){
    var $this = $(This);
    var dialog_id = $this.attr('dialog_id');
    layer.load();
    $.get(
        '/baseapi/comment/dialog_lists',
        {
            dialog_id: dialog_id
        },
        function(json){
            if(json.error_code == 'ok'){
                create_dialog_html(json);
            }
            else{
                show_error(json.error_code);
            }
            layer.closeAll('loading');
        },
        'json'
    );
}

//构建对话弹出层的html
function create_dialog_html(json){
    var dialog_lists = json.dialog_lists;
    var counts = dialog_lists.length;
    var html = '<ul class="jieda" style="padding:0 20px;">';
    for(var i = 0; i < counts; i++){
        var comment = dialog_lists[i];
        html += create_comment_html(comment);
    }
    html += '</ul>';
    layer.closeAll();
    layer.open({
        type: 1,
        title: '查看对话',
        shadeClose: true,
        shift:5,
        shade: false,
        area: ['760px', '500px'],
        maxmin: true,
        shade: [0.3, '#000'],
        scrollbar: false,
        content: html,
        success: function(){
            $('pre>code').each(function(i, block) {
                hljs.highlightBlock(block);
            });
        }
    });
}

//创建评论的html
function create_comment_html(comment){
    var vote_html = '';
    if(typeof comment['vote_type'] == 'undefined' && comment['vote_type'] != null){
        if(comment['vote_type'] == 1){
            vote_html = '<div class="votes voted">'
                            +'<a class="vote vote_counts" vote_counts="' + comment['vote_counts'] + '" href="javascript:;" title="综合得票' + comment['vote_counts'] + '"><i class="iconfont">' + (comment['vote_counts'] > 0 ? '+' + comment['vote_counts'] : comment['vote_counts']) + '</i></a> '
                            +'<a class="vote active" href="javascript:;" comment_id="' + comment['id'] + '" vote_up_counts="' + comment['vote_up_counts'] + '" title="' + comment['vote_up_counts'] + '人支持，您已支持">'
                                +'<i class="iconfont">&#xe618;</i>'
                            +'</a> '
                            +'<a class="vote" href="javascript:;" comment_id="' + comment['id'] + '" vote_down_counts="' + comment['vote_down_counts'] + '" title="' + comment['vote_down_counts'] + '人反对">'
                                +'<i class="iconfont">&#xeefe;</i>'
                            +'</a>'
                        +'</div>';
        }
        else if(comment['vote_type'] == 2){
            vote_html = '<div class="votes voted">'
                            +'<a class="vote vote_counts" vote_counts="' + comment['vote_counts'] + '" href="javascript:;" title="综合得票' + comment['vote_counts'] + '"><i class="iconfont">' + (comment['vote_counts'] > 0 ? '+' + comment['vote_counts'] : comment['vote_counts']) + '</i></a> '
                            +'<a class="vote" href="javascript:;" comment_id="' + comment['id'] + '" vote_up_counts="' + comment['vote_up_counts'] + '" title="' + comment['vote_up_counts'] + '人支持">'
                                +'<i class="iconfont">&#xe618;</i>'
                            +'</a> '
                            +'<a class="vote active" href="javascript:;" comment_id="' + comment['id'] + '" vote_down_counts="' + comment['vote_down_counts'] + '" title="' + comment['vote_down_counts'] + '人反对，您已反对">'
                                +'<i class="iconfont">&#xeefe;</i>'
                            +'</a>'
                        +'</div>';
        }
    }
    else{
        vote_html = '<div class="votes">'
                        +'<a class="vote vote_counts" vote_counts="' + comment['vote_counts'] + '" href="javascript:;" title="综合得票' + comment['vote_counts'] + '"><i class="iconfont">' + (comment['vote_counts'] > 0 ? '+' + comment['vote_counts'] : comment['vote_counts']) + '</i></a> '
                        +'<a class="vote" href="javascript:;" comment_id="' + comment['id'] + '" vote_up_counts="' + comment['vote_up_counts'] + '" onclick="comment_vote(this, 1);" title="' + comment['vote_up_counts'] + '人支持">'
                            +'<i class="iconfont">&#xe618;</i>'
                        +'</a> '
                        +'<a class="vote" href="javascript:;" comment_id="' + comment['id'] + '" vote_down_counts="' + comment['vote_down_counts'] + '" onclick="comment_vote(this, 2);" title="' + comment['vote_down_counts'] + '人反对">'
                            +'<i class="iconfont">&#xeefe;</i>'
                        +'</a>'
                    +'</div>';
    }
    var reply_html = '';
    if(comment['dialog_id'] == null){
        reply_html = '<div class="jieda-reply">'
                        +'<span class="time">' + comment['add_time'] + '</span>'
                        +'<a class="reply_show_btn" href="javascript:;" comment_id="' + comment['id'] + '" dialog_id="" nickname="' + comment['nickname'] + '" onclick="comment_reply_show(this);"><i class="iconfont">&#xe619;</i>回复</a>'
                    +'</div>'
    }
    else{
        reply_html = '<div class="jieda-reply">'
                        +'<span class="time">' + comment['add_time'] + '</span>'
                        +'<a class="dialog_show_btn" href="javascript:;" dialog_id="' + comment['dialog_id'] + '" onclick="dialog_show(this);"><i class="iconfont">&#xe792;</i>查看对话</a>'
                        +'<a class="reply_show_btn" href="javascript:;" comment_id="' + comment['id'] + '" dialog_id="' + comment['dialog_id'] + '" nickname="' + comment['nickname'] + '" onclick="comment_reply_show(this);"><i class="iconfont">&#xe619;</i>回复</a>'
                    +'</div>'
    }
    var html = '<li class="jieda-daan">'
                +'<div class="detail-about detail-about-reply">'
                    +'<a class="jie-user" href="/u/home/' + comment['user_id'] + '">'
                        +'<img src="' + create_avatar_url(comment['user_id'], comment['avatar_ext']) + '">'
                    +'</a>'
                +'</div>'
                +'<div class="detail-body jieda-body">'
                    +'<div class="mb5">'
                        +vote_html
                        +' <a href="/u/home/' + comment['user_id'] + '">' + comment['nickname'] + '</a>'
                    +'</div>'
                    +html_newline(content_xss_filter(comment['comment_content']))
                +'</div>'
                +reply_html
            +'</li>';
    return html;
}

//提问投票
function article_vote(This, vote_type){
    var $this = $(This);
    var article_id = $this.attr('article_id');

    $.post(
        '/api/articlevote/vote',
        {
            article_id: article_id,
            vote_type: vote_type
        },
        function(json){
            vote_success_callback($this, vote_type, json);
        },
        'json'
    );
}

//评论投票
function comment_vote(This, vote_type){
    var $this = $(This);
    var comment_id = $this.attr('comment_id');

    $.post(
        '/api/commentvote/vote',
        {
            comment_id: comment_id,
            vote_type: vote_type
        },
        function(json){
            vote_success_callback($this, vote_type, json);
        },
        'json'
    );
}

//投票成功后的回调
function vote_success_callback($this, vote_type, json){
    if(json.error_code == 'ok'){
        var $votes = $this.parent('.votes');
        $('>.vote', $votes).removeAttr('onclick');
        var $vote_counts = $('>.vote_counts', $votes);
        $votes.addClass('voted');
        $this.addClass('active');
        var vote_counts = parseInt($vote_counts.attr('vote_counts'));
        if(vote_type == 1){
            var vote_up_counts = parseInt($this.attr('vote_up_counts'));
            vote_up_counts++;
            $this.attr('vote_up_counts', vote_up_counts);
            $this.attr('title', vote_up_counts + '人支持，您已支持');
            vote_counts++;
        }
        else if(vote_type == 2){
            var vote_down_counts = parseInt($this.attr('vote_down_counts'));
            vote_down_counts++;
            $this.attr('vote_down_counts', vote_down_counts);
            $this.attr('title', vote_down_counts + '人反对，您已反对');
            vote_counts--;
        }
        $votes.attr('vote_counts', vote_counts);
        $('>i', $vote_counts).html(vote_counts > 0 ? '+' + vote_counts : vote_counts);
    }
    else{
        show_error(json.error_code);
    }
}

/*******************************************我是华丽的分割线****************************************************/

//搜索框事件
$(function(){
    {
        //搜索页面自动给搜索框焦点
        var $search_wd = $('#search_wd');
        var wd = $search_wd.val();
        if(wd != ''){
            $search_wd.val(wd).focus();
        }
    }
    $(document).on('mouseenter mouseleave', '#search_box',
        function(event){
            if(event.type == 'mouseenter'){
                //元素未显示时设置焦点无效
                setTimeout(function(){
                    var $search_wd = $('#search_wd');
                    var wd = $search_wd.val();
                    if(!$search_wd.is(':focus')){
                        $('#search_wd').val(wd).focus();
                    }
                }, 600);
            }
            else if(event.type == 'mouseleave'){
                //鼠标离开时，如果搜索输入框已获得焦点或者不为空则显示，否则隐藏
                var $search_wd = $('#search_wd');
                if($search_wd.is(':focus') || $search_wd.val() != ''){
                    $(this).attr('_focus', '');
                }
                else{
                    $(this).removeAttr('_focus');
                }
            }
        }
    );
});

//搜索框失去焦点事件
function search_input_blur(This){
    var $this = $(This);
    if($('#search_wd').val() == ''){
        $('#search_box').removeAttr('_focus');
    }
}

//提交搜索
function search_onsubmit(){
    layer.closeAll();
    var wd = $('#search_wd').val();
    if(!simple_validate.required(wd)){
        layer.msg('请输入搜索词...');
        return false;
    }
    $('#search_wd').val('site:' + CONFIG['site_info']['domain'] + ' ' + wd);
    setTimeout(
        function(){
            $('#search_wd').val(wd);
        },
        100
    );
}

//百度搜索推荐词回调函数，用于获取用户当前选择的文字
function bdSug_show(wd){
    $('#search_wd').val('site:' + CONFIG['site_info']['domain'] + ' ' + wd);
    setTimeout(
        function(){
            $('#search_wd').val(wd);
        },
        300
    );
}

//百度搜索推荐词配置
var bdSug_params = {
    'XOffset' : 0, //提示框位置横向偏移量,单位px
    'YOffset' : 1, //提示框位置纵向偏移量,单位px
    'width' : 262, //提示框宽度，单位px
    'fontColor' : '#555', //提示框文字颜色
    'fontColorHI' : '#555', //提示框高亮选择时文字颜色
    'fontSize' : '14px',        //文字大小
    'fontFamily' : 'simsun',    //文字字体
    'borderColor' : '#ccc',     //提示框的边框颜色
    'bgcolorHI' : '#f0f0f0',        //提示框高亮选择的颜色
    'sugSubmit' : true      //在选择提示词条是是否提交表单
};

//百度搜索推荐词事件绑定
if(typeof BaiduSuggestion != 'undefined'){
    BaiduSuggestion.bind('search_wd', bdSug_params, bdSug_show);
}

/*******************************************我是华丽的分割线****************************************************/

//绑定邮箱
function bind_email_show(){
    var html = '<div class="layui-form layui-form-pane p30">'
                    +'<form method="post" onsubmit="return bind_email();">'
                        +'<div class="layui-form-item">'
                            +'<label for="email" class="layui-form-label">邮箱</label>'
                            +'<div class="layui-input-inline">'
                                +'<input type="text" id="email" name="email" class="layui-input">'
                            +'</div>'
                        +'</div>'
                        +'<div class="layui-form-item">'
                            +'<label for="pwd" class="layui-form-label">密码</label>'
                            +'<div class="layui-input-inline">'
                                +'<input type="password" id="pwd" name="pwd" class="layui-input">'
                            +'</div>'
                        +'</div>'
                        +'<div class="layui-form-item">'
                            +'<button class="layui-btn" type="submit">立即绑定</button>'
                        +'</div>'
                    +'</form>'
                +'</div>';
    layer.closeAll();
    layer.open({
        type: 1,
        title: '绑定邮箱',
        shadeClose: true,
        shift:5,
        shade: false,
        area: ['440px', '270px'],
        content: html,
        success: function(){
            $('#email').focus();
        }
    });
}

//绑定邮箱
function bind_email(){
    var $email = $('#email');
    var $pwd = $('#pwd');
    var email = $email.val();
    var pwd = $pwd.val();

    if(!simple_validate.required(email)){
        layer.msg('请填写邮箱');
        $email.focus();
        return false;
    }

    if(!simple_validate.email(email)){
        layer.msg('请填写正确的邮箱');
        $email.focus();
        return false;
    }

    if(!simple_validate.range(email, 0, 30)){
        layer.msg('邮箱最大长度为30');
        $email.focus();
        return false;
    }

    if(!simple_validate.required(pwd)){
        layer.msg('请填写密码');
        $pwd.focus();
        return false;
    }

    if(!simple_validate.range(pwd, 6, 16)){
        layer.msg('密码长度为6-16位');
        $pwd.focus();
        return false;
    }

    layer.load();
    $.post(
        '/api/account/bind_email',
        {
            email: email,
            pwd: pwd
        },
        function(json){
            layer.closeAll();
            if(json.error_code == 'ok'){
                layer.alert('绑定成功，请到您的邮箱中激活您的绑定账号。<br><a href="' + json.email_homepage + '">进入邮箱&raquo;</a>', {icon:0, shade:0, title:'提示'});
            }
            else{
                show_error(json.error_code);
            }
        },
        'json'
    );
    return false;
}

//重发验证邮件
function resend_bind_email(){
    var confirm_tip = '确认重新发送验证邮件吗？';
    layer.confirm(confirm_tip, {icon: 3, shade:0, title:'提示'}, function(index){
        layer.load();
        $.post(
            '/api/account/resend_bind_email',
            {},
            function(json){
                if(json.error_code == 'ok'){
                    layer.alert('邮件重发成功。<br><a href="' + json.email_homepage + '">进入邮箱&raquo;</a>', {icon:0, shade:0, title:'提示'});
                }
                else{
                    layer.closeAll('loading');
                    show_error(json.error_code);
                }
            },
            'json'
        );
        layer.close(index);
    });
}

/*******************************************我是华丽的分割线****************************************************/

//冒泡start

//冒泡提交
//add_from 1=从mini冒泡提交冒泡 2=从冒泡页面发送
function maopao_add(This, add_from){
    var $this = $(This);
    var $maopao_content = $(' textarea', $this);
    var maopao_content = $maopao_content.val();

    if(!simple_validate.required(maopao_content)){
        layer.msg('请填写冒泡内容');
        $maopao_content.focus();
        return false;
    }

    if(!simple_validate.mix_range(maopao_content, 10, 140)){
        layer.msg('冒泡内容长度应为10-140位，1个中文算是2个字符长度');
        $maopao_content.focus();
        return false;
    }

    layer.load();
    $.post(
        '/api/maopao/add',
        {
            maopao_content: maopao_content
        },
        function(json){
            layer.closeAll('loading');
            if(json.error_code == 'ok'){
                $maopao_content.val('');
                layer.msg('冒泡成功');
                if(add_from == 1){
                    var html = create_maopao_html(json.maopao, false);
                }
                else{
                    var html = create_maopao_html(json.maopao, true);
                }
                $('#latest_maopao>.fly-none').remove();
                $('#latest_maopao').prepend(html);
                create_dom_notice($('#latest_maopao>li:first'));
            }
            else{
                show_error(json.error_code);
            }
        },
        'json'
    );

    return false;
}

//构造冒泡html
//is_vote_html false=不需要生成投票的html
function create_maopao_html(pao, is_vote_html){
    var vote_html = '';
    if(is_vote_html){
        if(typeof pao['vote_type'] == 'undefined' && pao['vote_type'] != null){
            if(pao['vote_type'] == 1){
                vote_html = '<div class="votes voted">'
                                +'<a class="vote vote_counts" vote_counts="' + pao['vote_counts'] + '" href="javascript:;" title="综合得票' + pao['vote_counts'] + '"><i class="iconfont">' + (pao['vote_counts'] > 0 ? '+' + pao['vote_counts'] : pao['vote_counts']) + '</i></a> '
                                +'<a class="vote active" href="javascript:;" maopao_id="' + pao['id'] + '" vote_up_counts="' + pao['vote_up_counts'] + '" title="' + pao['vote_up_counts'] + '人支持，您已支持">'
                                    +'<i class="iconfont">&#xe618;</i>'
                                +'</a> '
                                +'<a class="vote" href="javascript:;" maopao_id="' + pao['id'] + '" vote_down_counts="' + pao['vote_down_counts'] + '" title="' + pao['vote_down_counts'] + '人反对">'
                                    +'<i class="iconfont">&#xeefe;</i>'
                                +'</a>'
                            +'</div>';
            }
            else if(pao['vote_type'] == 2){
                vote_html = '<div class="votes voted">'
                                +'<a class="vote vote_counts" vote_counts="' + pao['vote_counts'] + '" href="javascript:;" title="综合得票' + pao['vote_counts'] + '"><i class="iconfont">' + (pao['vote_counts'] > 0 ? '+' + pao['vote_counts'] : pao['vote_counts']) + '</i></a> '
                                +'<a class="vote" href="javascript:;" maopao_id="' + pao['id'] + '" vote_up_counts="' + pao['vote_up_counts'] + '" title="' + pao['vote_up_counts'] + '人支持">'
                                    +'<i class="iconfont">&#xe618;</i>'
                                +'</a> '
                                +'<a class="vote active" href="javascript:;" maopao_id="' + pao['id'] + '" vote_down_counts="' + pao['vote_down_counts'] + '" title="' + pao['vote_down_counts'] + '人反对，您已反对">'
                                    +'<i class="iconfont">&#xeefe;</i>'
                                +'</a>'
                            +'</div>';
            }
        }
        else{
            vote_html = '<div class="votes">'
                            +'<a class="vote vote_counts" vote_counts="' + pao['vote_counts'] + '" href="javascript:;" title="综合得票' + pao['vote_counts'] + '"><i class="iconfont">' + (pao['vote_counts'] > 0 ? '+' + pao['vote_counts'] : pao['vote_counts']) + '</i></a> '
                            +'<a class="vote" href="javascript:;" maopao_id="' + pao['id'] + '" vote_up_counts="' + pao['vote_up_counts'] + '" onclick="maopao_vote(this, 1);" title="' + pao['vote_up_counts'] + '人支持">'
                                +'<i class="iconfont">&#xe618;</i>'
                            +'</a> '
                            +'<a class="vote" href="javascript:;" maopao_id="' + pao['id'] + '" vote_down_counts="' + pao['vote_down_counts'] + '" onclick="maopao_vote(this, 2);" title="' + pao['vote_down_counts'] + '人反对">'
                                +'<i class="iconfont">&#xeefe;</i>'
                            +'</a>'
                        +'</div>';
        }
    }
    
    var reply_html = '<div class="jieda-reply">'
                        +'<span class="time">' + pao['add_time'] + '</span>'
                        +'<a class="reply_show_btn" href="/maopao/detail/' + pao['id'] + '" maopao_id="' + pao['id'] + '" comment_id="" dialog_id="" nickname="" target="_blank"><i class="iconfont">&#xe619;</i>回复</a>'
                    +'</div>';

    var html = '<li class="jieda-daan">'
                +'<div class="detail-about detail-about-reply">'
                    +'<a class="jie-user" href="/u/home/' + pao['user_id'] + '">'
                        +'<img src="' + create_avatar_url(pao['user_id'], pao['avatar_ext']) + '">'
                    +'</a>'
                +'</div>'
                +'<div class="detail-body jieda-body">'
                    +'<div class="mb5">'
                        +vote_html
                        +' <a href="/u/home/' + pao['user_id'] + '">' + pao['nickname'] + '</a>'
                    +'</div>'
                    +html_newline(content_xss_filter(pao['maopao_content']))
                +'</div>'
                +reply_html
            +'</li>';
    return html;
}

//显示冒泡回复评论框
function maopao_comment_reply_show(This){
    //注意这个num是包围编辑器的num，并不是编辑器的num
    var num = new Date().getTime();
    var $this = $(This);
    var maopao_id = $this.attr('maopao_id');
    var comment_id = $this.attr('comment_id');
    var dialog_id = $this.attr('dialog_id');
    var nickname = $this.attr('nickname');

    var $reply = $this.parent('div').children('.reply');
    if($reply.length == 0){
        var rich_editor_wrapper_id = 'rich_editor_wrapper_' + num;
        var html = '<div class="layui-form layui-form-pane reply mt10 none">'
                        +'<form method="post" maopao_id="' + maopao_id + '" comment_id="' + comment_id + '" dialog_id="' + dialog_id + '" onsubmit="return maopao_comment_add(this);">'
                            +'<div id="rich_editor_wrapper_' + num + '" num="' + num + '"></div>'
                            +'<div class="layui-form-item tr">'
                                +'<button type="submit" class="layui-btn layui-btn-small layui-btn-danger"><i class="iconfont">&#xe619;</i> 回复</button>'
                            +'</div>'
                        +'</form>'
                    +'</div>';
        $this.parent('div').append(html);
        var num = create_rich_editor(rich_editor_wrapper_id, '', '请输入回复内容', '80', false);
        $reply = $this.parent('div').children('.reply');
        if(nickname != ''){
            $('#rich_content_' + num).val('回复@' + nickname + ':');
        }
        $reply.stop(true, true).slideDown(300, function(){
            $('#rich_content_' + num).focus();
        });
    }
    else{
        if($reply.is(':visible')){
            $reply.stop(true, true).slideUp(300);
        }
        else{
            $reply.stop(true, true).slideDown(300, function(){
                $(' textarea', $reply).focus();
            });
        }
    }
}

//提交冒泡评论
function maopao_comment_add(This){
    var $this = $(This);
    var $comment_content = $(' textarea', $this);
    var comment_content = $comment_content.val();
    var maopao_id = $this.attr('maopao_id');
    var comment_id = $this.attr('comment_id');
    var dialog_id = $this.attr('dialog_id');

    if(!simple_validate.required(comment_content)){
        layer.msg('请填写回复内容');
        $comment_content.focus();
        return false;
    }

    if(!simple_validate.mix_range(comment_content, 10, 140)){
        layer.msg('回复内容长度应为10-140位，1个中文算是2个字符长度');
        $comment_content.focus();
        return false;
    }

    $.post(
        '/api/maopaocomment/add',
        {
            maopao_id: maopao_id,
            comment_content: comment_content,
            comment_id: comment_id,
            dialog_id: dialog_id
        },
        function(json){
            if(json.error_code == 'ok'){                
                var html = create_maopao_comment_html(json.comment);
                $('.jieda>.fly-none').remove();
                $('.jieda').append(html);
                create_dom_notice($('.detail>.jieda>li:last'));

                //隐藏回复框
                $comment_content.val('');
                var $jieda_reply = $this.parents('.jieda-reply');
                $jieda_reply.children('.reply').remove();

                layer.msg('回复成功');
            }
            else{
                show_error(json.error_code);
            }
        },
        'json'
    );
    return false;
}

//显示冒泡对话弹出层
function maopao_dialog_show(This){
    var $this = $(This);
    var dialog_id = $this.attr('dialog_id');
    layer.load();
    $.get(
        '/baseapi/maopaocomment/dialog_lists',
        {
            dialog_id: dialog_id
        },
        function(json){
            if(json.error_code == 'ok'){
                create_maopao_dialog_html(json);
            }
            else{
                show_error(json.error_code);
            }
            layer.closeAll('loading');
        },
        'json'
    );
}

//构建冒泡对话弹出层的html
function create_maopao_dialog_html(json){
    var dialog_lists = json.dialog_lists;
    var counts = dialog_lists.length;
    var html = '<ul class="jieda" style="padding:0 20px;">';
    for(var i = 0; i < counts; i++){
        var comment = dialog_lists[i];
        html += create_maopao_comment_html(comment);
    }
    html += '</ul>';
    layer.closeAll();
    layer.open({
        type: 1,
        title: '查看对话',
        shadeClose: true,
        shift:5,
        shade: false,
        area: ['760px', '500px'],
        maxmin: true,
        shade: [0.3, '#000'],
        scrollbar: false,
        content: html,
        success: function(){
            $('pre>code').each(function(i, block) {
                hljs.highlightBlock(block);
            });
        }
    });
}

//构建冒泡评论的html
function create_maopao_comment_html(comment){
    var vote_html = '';
    if(typeof comment['vote_type'] == 'undefined' && comment['vote_type'] != null){
        if(comment['vote_type'] == 1){
            vote_html = '<div class="votes voted">'
                            +'<a class="vote vote_counts" vote_counts="' + comment['vote_counts'] + '" href="javascript:;" title="综合得票' + comment['vote_counts'] + '"><i class="iconfont">' + (comment['vote_counts'] > 0 ? '+' + comment['vote_counts'] : comment['vote_counts']) + '</i></a> '
                            +'<a class="vote active" href="javascript:;" comment_id="' + comment['id'] + '" vote_up_counts="' + comment['vote_up_counts'] + '" title="' + comment['vote_up_counts'] + '人支持，您已支持">'
                                +'<i class="iconfont">&#xe618;</i>'
                            +'</a> '
                            +'<a class="vote" href="javascript:;" comment_id="' + comment['id'] + '" vote_down_counts="' + comment['vote_down_counts'] + '" title="' + comment['vote_down_counts'] + '人反对">'
                                +'<i class="iconfont">&#xeefe;</i>'
                            +'</a>'
                        +'</div>';
        }
        else if(comment['vote_type'] == 2){
            vote_html = '<div class="votes voted">'
                            +'<a class="vote vote_counts" vote_counts="' + comment['vote_counts'] + '" href="javascript:;" title="综合得票' + comment['vote_counts'] + '"><i class="iconfont">' + (comment['vote_counts'] > 0 ? '+' + comment['vote_counts'] : comment['vote_counts']) + '</i></a> '
                            +'<a class="vote" href="javascript:;" comment_id="' + comment['id'] + '" vote_up_counts="' + comment['vote_up_counts'] + '" title="' + comment['vote_up_counts'] + '人支持">'
                                +'<i class="iconfont">&#xe618;</i>'
                            +'</a> '
                            +'<a class="vote active" href="javascript:;" comment_id="' + comment['id'] + '" vote_down_counts="' + comment['vote_down_counts'] + '" title="' + comment['vote_down_counts'] + '人反对，您已反对">'
                                +'<i class="iconfont">&#xeefe;</i>'
                            +'</a>'
                        +'</div>';
        }
    }
    else{
        vote_html = '<div class="votes">'
                        +'<a class="vote vote_counts" vote_counts="' + comment['vote_counts'] + '" href="javascript:;" title="综合得票' + comment['vote_counts'] + '"><i class="iconfont">' + (comment['vote_counts'] > 0 ? '+' + comment['vote_counts'] : comment['vote_counts']) + '</i></a> '
                        +'<a class="vote" href="javascript:;" comment_id="' + comment['id'] + '" vote_up_counts="' + comment['vote_up_counts'] + '" onclick="maopao_comment_vote(this, 1);" title="' + comment['vote_up_counts'] + '人支持">'
                            +'<i class="iconfont">&#xe618;</i>'
                        +'</a> '
                        +'<a class="vote" href="javascript:;" comment_id="' + comment['id'] + '" vote_down_counts="' + comment['vote_down_counts'] + '" onclick="maopao_comment_vote(this, 2);" title="' + comment['vote_down_counts'] + '人反对">'
                            +'<i class="iconfont">&#xeefe;</i>'
                        +'</a>'
                    +'</div>';
    }
    var reply_html = '';
    if(comment['dialog_id'] == null){
        reply_html = '<div class="jieda-reply">'
                        +'<span class="time">' + comment['add_time'] + '</span>'
                        +'<a class="reply_show_btn" href="javascript:;" maopao_id="' + comment['maopao_id'] + '" comment_id="' + comment['id'] + '" dialog_id="" nickname="' + comment['nickname'] + '" onclick="maopao_comment_reply_show(this);"><i class="iconfont">&#xe619;</i>回复</a>'
                    +'</div>'
    }
    else{
        reply_html = '<div class="jieda-reply">'
                        +'<span class="time">' + comment['add_time'] + '</span>'
                        +'<a class="dialog_show_btn" href="javascript:;" dialog_id="' + comment['dialog_id'] + '" onclick="dialog_show(this);"><i class="iconfont">&#xe792;</i>查看对话</a>'
                        +'<a class="reply_show_btn" href="javascript:;" maopao_id="' + comment['maopao_id'] + '" comment_id="' + comment['id'] + '" dialog_id="' + comment['dialog_id'] + '" nickname="' + comment['nickname'] + '" onclick="maopao_comment_reply_show(this);"><i class="iconfont">&#xe619;</i>回复</a>'
                    +'</div>'
    }
    var html = '<li class="jieda-daan">'
                +'<div class="detail-about detail-about-reply">'
                    +'<a class="jie-user" href="/u/home/' + comment['user_id'] + '">'
                        +'<img src="' + create_avatar_url(comment['user_id'], comment['avatar_ext']) + '">'
                    +'</a>'
                +'</div>'
                +'<div class="detail-body jieda-body">'
                    +'<div class="mb5">'
                        +vote_html
                        +' <a href="/u/home/' + comment['user_id'] + '">' + comment['nickname'] + '</a>'
                    +'</div>'
                    +html_newline(content_xss_filter(comment['comment_content']))
                +'</div>'
                +reply_html
            +'</li>';
    return html;
}

//冒泡投票
function maopao_vote(This, vote_type){
    var $this = $(This);
    var maopao_id = $this.attr('maopao_id');

    $.post(
        '/api/maopaovote/vote',
        {
            maopao_id: maopao_id,
            vote_type: vote_type
        },
        function(json){
            vote_success_callback($this, vote_type, json);
        },
        'json'
    );
}

//冒泡评论投票
function maopao_comment_vote(This, vote_type){
    var $this = $(This);
    var comment_id = $this.attr('comment_id');

    $.post(
        '/api/maopaocommentvote/vote',
        {
            comment_id: comment_id,
            vote_type: vote_type
        },
        function(json){
            vote_success_callback($this, vote_type, json);
        },
        'json'
    );
}

//切换最新冒泡和热门冒泡
function maopao_switch(maopao_type){
    var $newSwitcher = $('#newSwitcher');
    var $hotSwitcher = $('#hotSwitcher');
    var $imgNew = $('#imgNew');
    var $imgTop = $('#imgTop');

    //最新
    if(maopao_type == 0){
        $hotSwitcher.removeClass('on');
        $newSwitcher.addClass('on');
        $imgNew.removeClass('img_new_off').addClass('img_new_on');
        $imgTop.removeClass('img_top_on').addClass('img_top_off');

        $('#hot_maopao').hide();
        $('#latest_maopao').show();
    }
    //热门
    else if(maopao_type == 1){
        $newSwitcher.removeClass('on');
        $hotSwitcher.addClass('on');
        $imgNew.removeClass('img_new_on').addClass('img_new_off');
        $imgTop.removeClass('img_top_off').addClass('img_top_on');

        $('#latest_maopao').hide();
        $('#hot_maopao').show();
    }
}

//冒泡end

/*******************************************我是华丽的分割线****************************************************/

//签到
function sign(This){
    var $this = $(This);

    layer.load();
    $.post(
        '/api/account/sign',
        {

        },
        function(json){
            layer.closeAll('loading');
            if(json['error_code'] == 'ok'){
                layer.msg('签到成功，获取' + json.sign_points + '积分，连续签到将获得更多积分。');
                var html = '<span class="t_green">已连续签到' + json.sign_info.con_sign_times + '天</span>';
                $this.parent('span').html(html);
            }
            else{
                show_error(json.error_code);
            }
        },
        'json'
    );
}

/*******************************************我是华丽的分割线****************************************************/

//关注
function follow(This){
    var $this = $(This);

    var ruser_id = $this.attr('ruser_id');
    layer.load();
    $.post(
        '/api/relationship/follow',
        {
            ruser_id: ruser_id
        },
        function(json){
            layer.closeAll('loading');
            if(json.error_code == 'ok'){
                var html = '';
                //单向关注
                if(json.relationship.rtype == 1){
                    html = '<button type="button" class="layui-btn layui-btn-small layui-btn-primary" ruser_id="' + ruser_id + '" onclick="unfollow(this);" title="取消关注"><i class="iconfont">&#xe68d;</i>已关注</button>';
                }
                //双向关注
                else if(json.relationship.rtype == 2){
                    html = '<button type="button" class="layui-btn layui-btn-small layui-btn-primary" ruser_id="' + ruser_id + '" onclick="unfollow(this);" title="取消关注"><i class="iconfont">&#xe61a;</i>互相关注</button>';
                }
                $this.replaceWith(html);
            }
            else{
                show_error(json.error_code);
            }
        },
        'json'
    );
}

//取消关注
function unfollow(This){
    var $this = $(This);

    var ruser_id = $this.attr('ruser_id');
    layer.confirm('确定要取消关注吗？', {icon: 3, shade:0, title:'提示'}, function(index){
        layer.load();
        $.post(
            '/api/relationship/unfollow',
            {
                ruser_id: ruser_id
            },
            function(json){
                layer.closeAll('loading');
                if(json.error_code == 'ok'){
                    var html = '';
                    html = '<button type="button" class="layui-btn layui-btn-small" ruser_id="' + ruser_id + '" onclick="follow(this);" title="关注"><i class="iconfont">&#xe68e;</i>关注</button>';
                    $this.replaceWith(html);
                }
                else{
                    show_error(json.error_code);
                }
            },
            'json'
        );
        layer.close(index);
    });
}

/*******************************************我是华丽的分割线****************************************************/


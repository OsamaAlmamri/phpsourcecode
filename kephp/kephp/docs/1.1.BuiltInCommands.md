# kephp 内建命令说明

## 基本说明

1. `$1` 表示为命令的第一个参数，`$0` 已经被要执行的命令所占用。

```shell
kephp git_export hash
# $0 => git_export
# $1 => hash

kephp new app my_app
# $0 => new ，new 其实是一个单独的指令，对于 new 而言 app 是他的 $0 ，在 new 内部，根据 $0 执行另外一个指令。
# $1 => my_app
```

2. 有一些指令在开发时预留了一些参数，但因为版本升级的缘故，有一些参数已经作古，具体请以该文档的内容为标准。
3. 所有命令，都可以加上 `--help` 查看指令格式说明，如 `kephp new app --help` 。
4. 命令的执行，支持中划线、下划线，驼峰命名风格，如：`kephp git-export` 、`kephp git_export` 、`kephp GitExport` 是同一个指令，请使用最喜欢的方式去调用。
5. 命令的参数，不支持空格分隔符，只支持 `=`，如： `--listen localhost:9091` ，被视为两个参数，正确格式应该是 `--listen=localhost:9091`

## 新建应用程序

```shell
kephp new app <appDir> [--namespace|-n=appNamespace]
```

**参数说明**

| 参数 | 必填 | 说明 |
|-----|:---:|------|
| $1 | ✅ | 要创建的应用程序目录 |
| --namespace,-n | ❎ | 创建的应用的命名空间，可以省略开头的 `\` <br>为空时，根据 appDir 自动生成，首字母大写驼峰命名 |

举例：

```shell
# 创建目录 my_app ，命名空间为 MyApp
kephp new app my_app
# 创建目录 /var/www/new_blog ，命名空间为 User\\Blog
kephp new app /var/www/new_blog --namespace=User\\Blog

# 命令行需要输入两个 \\ ，才是正确的 namespace 分隔符的输入，可以输入 / 来替代
kephp new app /var/www/new_blog --namespace=User/Blog
```

## 应用程序内常用命令

### 新建应用程序命令 Cmd

```shell
kephp new cmd <name> [--is-ref]
```

**参数说明**

| 参数 | 必填 | 说明 |
|-----|:---:|------|
| $1 | ✅ | 新建的命令名，输入该指令后，会提示选择要创建的类名的风格 |
| --is-ref | ❎ | 默认为 `true` , 是否使用自动反射指令 |

**补充说明**

1. 执行 `new cmd` 后，会提供一个清单，供开发者选择要创建的指令的类名，内容如下：

```shell
kephp new cmd test
[0] New_App\Cmd\Test (/Projects/new_app/src/Kephp_Test/New_App/Cmd/Test.php)
[1] New_App\Cmd\test (/Projects/new_app/src/Kephp_Test/New_App/Cmd/test.php)
[2] Cmd\Test (/Projects/new_app/src/Cmd/Test.php)
[3] Cmd\test (/Projects/new_app/src/Cmd/test.php)
Please choice class name(input the number):
```

2. 新建的指令，在应用程序的根目录，执行 `kephp test` 即可启动该指令。

**应用程序命令简介**

应用程序命令提供给开发者在与当前应用程序相同环境下（数据库、缓存、类），以PHP的方式编写各种运维的脚本，并可简便、快捷的执行。

kephp 允许同名命令重载，指令加载顺序 app > kephp 。

比如，kephp 内建了 `scan_tables` 命令，用于将数据库的表字段自动转换为 ModelClass 的属性。内建的 `scan_tables` 转换出来的类名，是以项目命名空间下的 `AppNamespace\Db\Table` 的格式生成的。

开发者可以在应用程序内创建一个同样名为 `scan_tables` 的命令，可继承自 `Ke\Cli\Cmd\ScanTables` ，然后对他的局部方法（比如生成的类名）进行重载。

这时，在应用程序内执行 `scan_tables` 则会优先选择应用程序内的命令来执行，而忽略 kephp 内建的命令。

关于应用程序命令的开发，请参考 [kephp 命令开发教程](6.0.CommandDevTut.md) 。

### 新建网站控制器 Controller

```shell
kephp new controller index
```

**参数说明**

| 参数 | 必填 | 说明 |
|-----|:---:|------|
| $1 | ✅ | 要创建的网站控制器的访问名，可以添加路径，如 `admin/index` |

网站控制器默认存放路径为 `src\AppNamespace\Controller` 。

**网站控制器简介**

网站控制器主要针对 web 请求的分发与处理。kephp 内建的 Controller 命名规则如下：

1. 访问名强制全小写，如 `Hello => hello`
2. 中划线转换为下划线，如 `Hello-World => hello_world`
3. 类名为首字母大写驼峰命名风格，保留下划线，后缀加 `Controller`，如上的例子对应为 `HelloController` ，`Hello_WorldController`。

说明：

- 访问名用于在项目内准确的定位当前的 controller。
- 用户可以通过重载应用程序内的 Web 类的方法，来重新定义控制器的命名规则。

具体的网站控制器与分发规则，请参考 [网站分发规则与网站控制器说明](2.1.WebDispatchRuleAndWebController.md) 。

### 新建网站动作 Action

```shell
kephp new action index#index
```

| 参数 | 必填 | 说明 |
|-----|:---:|------|
| $1 | ✅ | 动作名，以 `controller#action` 格式添加，<br>controller 可以加入路径，如 `admin/index#login` |

**网站动作简介**

网站动作指网站控制器对请求处理的编程入口。kephp 内建的 Action 命名规则如下：

1. 访问名强制全小写，同控制器
2. 中划线（其他特殊字符），转为下划线。
3. 无后缀
4. `RequestMethod` 前缀，针对对应的请求方法的同 action 的入口，如 `login` 、 `post_login` ，共享 get 方法执行。
5. 新建网站动作，会自动创建关联的网站视图

用户同样可以通过重载应用程序内的 Web 类的方法，来重新定义网站动作、视图的命名规则。

### 新建网站视图 View

```shell
kephp new view index#index
```

**参数说明**

| 参数 | 必填 | 说明 |
|-----|:---:|------|
| $1 | ✅ | 视图名称，以 `controller#action` 格式添加，<br>controller 可以加入路径，如 `admin/index#login` |

view 的命名规则与 action 保持一致。

*待补充 Template 规则*

### 新建网站组件 Widget

```shell
kephp new widget widgetName
```

**参数说明**

| 参数 | 必填 | 说明 |
|-----|:---:|------|
| $1 | ✅ | 组件名称，可带路径，如 `common/user/filter` |

网站组件存放路径为 `src/AppNamespace/Component` 。

### 新建网站布局 Layout

```shell
kephp new layout layoutName
```

| 参数 | 必填 | 说明 |
|-----|:---:|------|
| $1 | ✅ | 布局名称，可带路径，如 `admin/default` |

网站布局存放路径为 `src/AppNamespace/Component/layout` 。

### 启动网站服务器

```shell
kephp server [--listen|-l=<listen>] [--root|-r=<root>]
```

**参数说明**

| 参数 | 必填 | 说明 |
|-----|:---:|------|
| --listen,-l | ❎ | 监听主机名和端口，默认为 `localhost:8080` |
| --root,-r | ❎ | 服务器文档根目录，默认为当前目录，<br/>如果当前目录下存在 `public` 目录，则以 `public` 为根目录 |

### 扫描数据库表格

```shell
kephp scan_tables [<source>]
```

| 参数 | 必填 | 说明 |
|-----|:---:|------|
| $1 | ❎ | 要扫描的数据源，默认为 `default` |

`scan_tables` 实际执行的是 `new_model` 和 `update_model` ，不推荐单独使用 `new_model` 和 `update_model` 命令。

**Model说明**

请参考 [Model基础教程](3.0.ModelBasicTut.md) 。

### sync_db_model

```shell
kephp sync_db_model [<source>]
```

参数同上。

该命令主要为了解决表命名的 namespace 问题。新项目可以使用该指令，旧项目不建议使用。

使用时，需要在 `config/common.php` （或 `src/Namespace/App.php`）。

```php
<?php

const APP_MODEL_NAMESPACES = [
	'test' => true,   // 当表名中存在 test 则将其作为 Test 命名空间来处理
	'post' => 'CMS',  // 表名中存在 post 则将其作为 CMS 命名空间来处理
];

const APP_MODEL_CLS_SEP = ''; // 指定类名拼接的连接符，默认是 空字符
```

假定你的项目有以下的数据库的配置：

```php
<?php
use \Ke\Adm;

// Database config
Adm\Db::define([
	'default' => [
		'adapter'  => 'mysql',
		'db'       => 'my_app_dev',
		'user'     => 'root',
		'password' => '',
		'prefix'   => 'my_',
		'charset'  => 'utf8mb4',
	],
]);
```

该指令生成Class逻辑如下：

1. 生成 tableName 的 `Db\TableName` 类。
2. 根据 `APP_MODEL_NAMESPACES` 生成对应的 `Model\Namespace\ClassName`

从 `1.2.45` 开始，该指令生效，将 Db 和 Model 分开，一个项目请只使用 `scan_tables` 或者 `sync_db_model` 中的任意一种模式。

`APP_MODEL_NAMESPACES` 的命名空间转换示例（如上的配置中）：

my_hello_world   => MyApp\Db\Hello_World
my_test          => MyApp\Db\Test\Test
my_test_user     => MyApp\Db\Test\User
my_test_user_log => MyApp\Db\Test\User_Log
my_post          => MyApp\Db\CMS\Post
my_post_category => MyApp\Db\CMS\Category
my_post_tag      => MyApp\Db\CMS\Tag

```json
{
    "my_hello_world": {
        "db": "MyApp\\Db\\HelloWorld",
        "model": "MyApp\\Model\\HelloWorld"
    },
    "my_test": {
        "db": "MyApp\\Db\\Test",
        "model": "MyApp\\Model\\Test\\Test"
    },
    "my_test_user": {
        "db": "MyApp\\Db\\TestUser",
        "model": "MyApp\\Model\\Test\\User"
    },
    "my_test_user_log": {
        "db": "MyApp\\Db\\TestUserLog",
        "model": "MyApp\\Model\\Test\\UserLog"
    },
    "my_post": {
        "db": "MyApp\\Db\\Post",
        "model": "MyApp\\Model\\CMS\\Post"
    },
    "my_post_category": {
        "db": "MyApp\\Db\\PostCategory",
        "model": "MyApp\\Model\\CMS\\PostCategory"
    },
    "my_post_tag": {
        "db": "MyApp\\Db\\PostTag",
        "model": "MyApp\\Model\\CMS\\PostTag"
    }
}
```

### Git 导出版本更新文件

```shell
kephp git_export [<version>]
```

**参数说明**

| 参数 | 必填 | 说明 |
|-----|:---:|------|
| $1 | ❎ | 版本号的hash，默认为当前最后的版本号 |

导出的目录为当前目录下的 `export/version`

### Phar 打包

```shell
kephp phar_pack <dir> [<name>] [--export|-e=<export>]
```

**参数说明**

| 参数 | 必填 | 说明 |
|-----|:---:|------|
| $1 | ✅ | 要打包的目录 |
| $2 | ❎ | 生成的打包文件名 |
| --export,-e | ❎ | 输出的目录 |


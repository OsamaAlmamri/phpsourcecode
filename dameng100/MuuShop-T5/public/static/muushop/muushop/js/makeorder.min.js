"use strict";$(function(){var t=$('[data-role="address_list"]').data("url");$.get(t,"",function(t){var e="";if(t.code){var a=t.data;$.each(a,function(t,a){e+='<div class="col-md-3"><div class="address-box" data-id="'+a.id+'"><div class="address-info" data-type="address"><div class="title clearfix"><h3 class="address-user">'+a.name+'</h3><p class="address-phone">'+a.phone+'</p></div><div class="info">'+a.province+" "+a.city+" "+a.district+'</div><div class="info">'+a.address+'</div><div class="edit"><a class="edit-address-btn" data-toggle="modal" data-remote="/muushop/user/address/action/edit/id/'+a.id+'">编辑</a><a class="del-address-btn" data-toggle="modal" data-remote="/muushop/user/address/action/delete/id/'+a.id+'">删除</a></div></div><i></i></div></div>'}),$(".address-main .address-list").prepend(e),$(".address-box .title:first").trigger("click"),3<=a.length&&$(".more-address").removeClass("hidden")}},"json")}),$(function(){var c=$('input[data-type="delivery_id"]').data("value"),l=$('input[data-type="real_quantity"]').data("value");$(".address-list").on("click",".address-box",function(){$(".address-box").removeClass("selected"),$(".address-box").find(".edit a").hide(),$(this).addClass("selected"),$(this).find(".edit a").show();var t,a,e,i,d,s,r,n,o=$(this).data("id");t=".makeorder_address_box",a=$(".address-box.selected"),e=$.trim($(a).find(".info").text()),i=$.trim($(a).find(".title").text()),d="<span>寄送至："+e+"</span><span>收件人："+i+"</span>",$(t).html(d),s=function(){var t=totalPrice();$('span[data-type="total_price"]').attr("data-value",t).html(t),ableScoreMore()},r={id:c,address_id:o,quantity:l,express:"express"},n=$('[data-role="delivery"]').data("url"),$.get(n,r,function(t){if(1==t.code){var a=t.data;$("#freightPriceId i").text(a),s()}})}),$(".more-address").on("click",function(){$(".address-list").hasClass("in")?($(".address-list").removeClass("in"),$(this).find("span:first").text("更多地址"),$(this).find("span:eq(1)").html('<i class="icon icon-double-angle-down"></i>')):($(".address-list").addClass("in"),$(this).find("span:first").text("收起地址"),$(this).find("span:eq(1)").html('<i class="icon icon-double-angle-up"></i>'))})}),$(function(){$('[data-role="pay_type"]').on("click",function(){$('[data-role="pay_type"]').removeClass("selected"),$(this).addClass("selected")}),$('[data-role="pay_type"]:first').trigger("click")}),$(function(){$(".coupon-section .item").click(function(){var t=$(this);$(".item.selected").removeClass("selected"),$(".coupon-section .item").find(".receive a").text("立即使用>>"),t.addClass("selected"),t.find(".receive a").text("使用中"),cachBack();var a=totalPrice();$('span[data-type="total_price"]').attr("data-value",a).text(a)})});var ableScoreMore=function(){$('[data-type="score"]').each(function(){var t=$(this),a=t.find('[data-type="quantity"]').text(),e=t.find("[data-prop]").data("prop"),i=totalPrice()*e,d=parseInt(t.find("input").val());(""==d||isNaN(d))&&(d=0),i=i<a-d?i:a-d,t.find(".ableScoreNum").text(parseInt(i))})};function cachBack(){var t=0,a=0;$(".coupon-section .item.selected").data("value")&&(a=parseFloat($(".coupon-section .item.selected").data("value")));var e=$(".panel-body .return"),i=0;e.each(function(){i+=parseFloat($(this).text())}),t=a+parseFloat(i),$("#cachBackId i").text(t.toFixed(2))}function totalPrice(){var t=parseFloat($("#warePriceId i").text());return(t=t-parseFloat($("#cachBackId i").text())+parseFloat($("#freightPriceId i").text()))<=0?0:t.toFixed(2)}$(function(){$(".panel-body input").bind("input propertychange",function(){$(this);var t=$("#warePriceId i").text(),a=$("#freightPriceId i").text(),e=(parseInt(t),parseInt(a),parseInt($(this).data("prop"))),i=parseInt($(this).val());i<=0&&($(this).val(0),i=0),isNaN(i)&&(i=0);var d=parseInt($(this).parent().parent().find('[data-type="quantity"]').text());i>=parseFloat(d)&&($(this).val(d),i=d);var s=parseFloat(i/e);$(this).parent().parent().find(".return").text(s.toFixed(2)),cachBack(),ableScoreMore(),$('span[data-type="total_price"]').attr("data-value",totalPrice()).text(totalPrice())})}),$(function(){var n=$('input[data-type="delivery_id"]').data("value");$('[data-role="make-order"]').click(function(){var t=$(".address-section .address-box.selected").data("id");if(t){var a=$('[data-role="pay_type"].selected').data("value"),e=0;$('[data-type="score"] input').each(function(){$(this).val()&&(e=$(this).val())});var i=$(".coupon-section .item.selected").data("id"),d={address_id:t,pay_type:a,delivery_id:n,use_point:e,coupon_id:i,info:{remark:$(".remark-input").val(),invoice_title:$(".invoice-title").val()}},s=$('[data-type="cart_id"]').data("value");s&&(d.cart_id=s);var r=$(this).data("url");$.post(r,d,function(t){1==t.code?(toast.success(t.msg,"温馨提示"),setTimeout(function(){window.location.href=t.url},1e3)):toast.error(t.msg,"温馨提示")})}else toast.error("收货地址未选择","温馨提示")})});
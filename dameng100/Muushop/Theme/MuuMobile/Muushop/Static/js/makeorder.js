"use strict";$(function(){$.loadAddressData(function(a){if(a.status){var t=a.data,e="";$.each(t,function(a,t){e+='<div class="address-box" data-id="'+t.id+'"><div class="address-info" data-type="address"><span class="title" data-id="'+t.id+'"><span class="address-user">'+t.name+"</span> "+t.phone+'<i></i></span><span class="info">'+t.province+" "+t.city+" "+t.district+" "+t.address+'</span><span class="edit"><a class="edit-address-btn" data-toggle="modal" data-remote="/muushop/user/address/action/edit/id/'+t.id+'">编辑</a> <a class="del-address-btn" data-toggle="modal" data-remote="/muushop/user/address/action/del/id/'+t.id+'">删除</a></span></div></div>'}),$(".address-main .address-list").html(e),$(".address-box .title:first").trigger("click")}else toast.error(a.info,"温馨提示")}),$(".address-list").on("mouseover",".address-box",function(){$(this).find(".edit").show()}),$(".address-list").on("mouseout",".address-box",function(){$(this).find(".edit").hide()})}),$(function(){var a=$('input[data-type="delivery_id"]').data("value"),t=$('input[data-type="real_quantity"]').data("value");$(".address-list").on("click",".address-box",function(){$(".address-box .title").removeClass("selected"),$(this).find(".title").addClass("selected");var e,s,i,d,n,r,o,l=$(this).data("id");e=".makeorder_address_box",s=$(".address-box").find(".selected").parents(".address-box"),i=$.trim($(s).find(".info").text()),d=$.trim($(s).find(".title").text()),n="<span>寄送至："+i+"</span><span>收件人："+d+"</span>",$(e).html(n),r=function(){var a=totalPrice();$('span[data-type="total_price"]').attr("data-value",a).html(a),ableScoreMore()},o={id:a,areaid:l,quantity:t,express:"express"},$.get("/Muushop/api/delivery",o,function(a){if(1==a.status){var t=a.data.delivery_fee;$("#freightPriceId i").text(t),r()}})}),$(".more-address").on("click",function(){$(".address-list").hasClass("in")?($(".address-list").removeClass("in"),$(this).find("span:first").text("更多地址"),$(this).find("span:eq(1)").html('<i class="icon icon-double-angle-down"></i>')):($(".address-list").addClass("in"),$(this).find("span:first").text("收起地址"),$(this).find("span:eq(1)").html('<i class="icon icon-double-angle-up"></i>'))})}),$(function(){$(".pay-type").click(function(){var a=$(this);$(".pay-type").removeClass("selected"),a.addClass("selected"),"onlinepay"==a.data("value")?($(".inline-pay-type").removeClass("hidden"),$(".inline-pay-type").addClass("display")):($(".inline-pay-type").removeClass("display"),$(".inline-pay-type").addClass("hidden"))}),$(".pay-section .pay-type:first").trigger("click")}),$(function(){$(".coupon-section h3 span").on("click",function(a){a.stopPropagation();var t=$(".coupon-main");t.hasClass("hidden")?(t.removeClass("hidden"),t.addClass("display")):(t.addClass("hidden"),t.removeClass("display"))}),$(".coupon-list-box").click(function(){var a=$(this);$(".coupon-list-box.selected").removeClass("selected"),a.addClass("selected"),cachBack();var t=totalPrice();$('span[data-type="total_price"]').attr("data-value",t).text(t)})});var ableScoreMore=function(){$('[data-type="score"]').each(function(){var a=$(this),t=a.find('[data-type="quantity"]').text(),e=a.find("[data-exchange]").data("exchange"),s=totalPrice()*e,i=parseInt(a.find("input").val());(""==i||isNaN(i))&&(i=0),s=t-i>s?s:t-i,a.find(".ableScoreNum").text(parseInt(s))})};function cachBack(){var a=0,t=0;$(".coupon-list-box.selected").data("value")&&(t=parseFloat($(".coupon-list-box.selected").data("value")));var e=0;$(".panel-body .return").each(function(){e+=parseFloat($(this).text())}),a=t+parseFloat(e),$("#cachBackId i").text(a.toFixed(2))}function totalPrice(){var a=parseFloat($("#warePriceId i").text());return(a=a-parseFloat($("#cachBackId i").text())+parseFloat($("#freightPriceId i").text()))<=0?0:a.toFixed(2)}$(function(){$(".panel-body input").bind("input propertychange",function(){$(this);var a=$("#warePriceId i").text(),t=$("#freightPriceId i").text(),e=parseInt(a)+parseInt(t),s=parseInt($(this).data("exchange")),i=parseInt($(this).val());i<=0&&($(this).val(0),i=0),isNaN(i)&&(i=0);var d=parseInt($(this).parent().parent().find('[data-type="quantity"]').text());i>parseFloat(d)&&$(this).val(d),console.log("总积分："+d+"|输入值:"+i);var n=0;$(this).parents().siblings('[data-type="score"]').each(function(){var a=$(this).find("input").val();""==a&&(a=0);var t=$(this).find("input").data("exchange");n+=a/t});var r=e-n;(r*=s)>d&&(r=d),parseFloat(i)>parseFloat(r)&&($(this).val(parseInt(r)),i=r),console.log(r);var o=i/s;$(this).parent().parent().find(".return").text(o.toFixed(2)),cachBack(),ableScoreMore(),$('span[data-type="total_price"]').attr("data-value",totalPrice()).text(totalPrice())})}),$(function(){var a=$('input[data-type="delivery_id"]').data("value");$(".makeorderBtn").click(function(){var t=$(".address-section .title.selected").data("id");if(t){var e=$(".pay-type.selected").data("value");if("onlinepay"==e)var s=$(".paychannel.selected input").val();else s="";var i=$(".coupon-list-box.selected").data("id"),d={};$('[data-type="score"] input').each(function(){var a=$(this).data("id");a&&(d["score"+a]=$(this).val())});var n={address_id:t,pay_type:e,channel:s,delivery_id:a,use_point:d,coupon_id:i,info:{remark:$(".remark-input").val()}},r=$('[data-type="cart_id"]').data("value");if(r)n.cart_id=r;else{var o={0:{sku_id:$('[data-type="product_skuid"]').data("value"),quantity:$('[data-type="product_quantity"]').data("value")}};n.products=o}$.post("/Muushop/order/makeorder",n,function(a){1==a.status?(toast.success(a.info,"温馨提示"),setTimeout(function(){window.location.href=a.url},1e3)):toast.error(a.info,"温馨提示")})}else toast.error("收货地址未选择","温馨提示")})});